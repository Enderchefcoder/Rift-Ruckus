<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>RIFT RUCKUS</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-user-select:none;user-select:none}
html,body{overflow:hidden;height:100%;width:100%}
body{background:#0d1b2a;font-family:system-ui,sans-serif}
canvas{display:block;width:100vw;height:100vh;position:fixed;top:0;left:0}
.vignette{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:50;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,.45) 100%)}
#hud{position:fixed;top:0;left:0;right:0;pointer-events:none;z-index:100;padding:10px}
.hud-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.panel{background:rgba(15,25,45,.92);border-radius:16px;pointer-events:auto;border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(10px)}
.player-info{padding:10px 14px;display:flex;align-items:center;gap:12px}
.avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#e74c3c,#27ae60);display:flex;align-items:center;justify-content:center;font-size:22px;border:2px solid rgba(255,255,255,.3)}
.pname{font-size:14px;font-weight:700;color:#fff}
.plevel{font-size:11px;color:rgba(255,255,255,.6)}
.coins{display:flex;gap:6px}
.coin{padding:8px 12px;display:flex;align-items:center;gap:6px;font-weight:700;font-size:13px;color:#fff}
.joy-area{position:fixed;bottom:25px;width:120px;height:120px;z-index:200}
#joyL{left:18px}
#joyR{right:18px}
.joy-ring{position:absolute;width:100%;height:100%;border-radius:50%;background:rgba(255,255,255,.08);border:3px solid rgba(255,255,255,.2)}
.joy-knob{position:absolute;width:52px;height:52px;border-radius:50%;background:linear-gradient(145deg,#fff,#ccc);box-shadow:0 4px 18px rgba(0,0,0,.5);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
.joy-label{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:600;color:rgba(255,255,255,.6);text-transform:uppercase}
.btns{position:fixed;bottom:160px;right:14px;display:flex;gap:10px;z-index:200}
.btn{width:58px;height:58px;border-radius:50%;border:none;font-size:24px;cursor:pointer;position:relative;box-shadow:0 4px 18px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
.btn:active{transform:scale(.85)}
.btn.hidden{display:none!important}
.btn-jump{background:linear-gradient(145deg,#3498db,#2980b9)}
.btn-grab{background:linear-gradient(145deg,#e74c3c,#c0392b)}
.btn-skill{background:linear-gradient(145deg,#9b59b6,#8e44ad)}
.btn-cd{position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#fff}
.btn.cd .btn-cd{display:flex}
.btn.cd{opacity:.4}
.btn-label{position:absolute;bottom:-15px;font-size:8px;font-weight:600;color:rgba(255,255,255,.8);white-space:nowrap}
.side-btns{position:fixed;bottom:275px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:200}
.side-btn{width:46px;height:46px;border-radius:50%;border:none;font-size:18px;cursor:pointer;box-shadow:0 3px 14px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
.emote-btn{background:linear-gradient(145deg,#f1c40f,#d4ac0d)}
.sprint-btn{background:linear-gradient(145deg,#7f8c8d,#616a6b)}
.sprint-btn.on{background:linear-gradient(145deg,#2ecc71,#27ae60)}
.emote-pop{position:fixed;bottom:340px;right:16px;background:rgba(15,25,45,.97);border-radius:16px;padding:10px;display:none;z-index:250;border:1px solid rgba(255,255,255,.12)}
.emote-pop.show{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.emote-pop button{width:40px;height:40px;border-radius:10px;border:none;font-size:20px;background:rgba(255,255,255,.1);cursor:pointer}
.prompt{position:fixed;bottom:300px;left:50%;transform:translateX(-50%);padding:14px 26px;border-radius:28px;display:none;align-items:center;gap:12px;z-index:150;background:rgba(15,25,45,.95);border:2px solid rgba(255,255,255,.15)}
.prompt.show{display:flex}
.prompt-icon{font-size:26px}
.prompt-text{font-weight:700;font-size:14px;color:#fff}
.prompt-go{background:linear-gradient(135deg,#e74c3c,#27ae60);color:#fff;border:none;padding:10px 22px;border-radius:18px;font-weight:700;font-size:13px;cursor:pointer}
.indicator{position:fixed;top:140px;left:50%;transform:translateX(-50%);padding:12px 24px;background:rgba(0,0,0,.9);border-radius:20px;color:#fff;font-weight:700;font-size:14px;z-index:150;display:none;border:2px solid #ffd700;text-align:center}
.indicator.show{display:block}
.minimap{position:fixed;top:78px;right:10px;width:100px;height:100px;background:rgba(0,0,0,.75);border-radius:14px;border:2px solid rgba(255,255,255,.2);z-index:95;display:none;overflow:hidden}
.minimap.show{display:block}
.mm-me{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:10px;background:#ffd700;border-radius:50%;box-shadow:0 0 8px #ffd700;z-index:2;border:2px solid #fff}
.mm-dot{position:absolute;width:7px;height:7px;border-radius:50%;transform:translate(-50%,-50%)}
.mm-dot.bot{background:#ff6b6b;box-shadow:0 0 5px #ff6b6b}
.mm-dot.it{background:#ff00ff;box-shadow:0 0 8px #ff00ff}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:500;display:none;align-items:center;justify-content:center;padding:16px}
.overlay.show{display:flex}
.box{background:linear-gradient(180deg,#1a2a40,#0f1a2a);border-radius:22px;width:100%;max-width:380px;max-height:82vh;display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
.box-head{padding:18px;text-align:center;border-bottom:1px solid rgba(255,255,255,.08)}
.box-head h2{font-size:22px;color:#fff}
.box-head p{font-size:12px;color:rgba(255,255,255,.5);margin-top:4px}
.box-body{padding:14px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.box-x{position:absolute;top:14px;right:14px;width:34px;height:34px;border-radius:50%;background:#e74c3c;border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ml{display:flex;flex-direction:column;gap:12px}
.mc{background:rgba(255,255,255,.07);border-radius:14px;padding:14px;cursor:pointer;display:flex;align-items:center;gap:14px}
.mc:active{background:rgba(255,255,255,.14)}
.mc-icon{font-size:32px;width:44px;text-align:center}
.mc-info h4{font-size:15px;font-weight:700;color:#fff}
.mc-info p{font-size:11px;color:rgba(255,255,255,.5);margin-top:2px}
.cg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.cc{background:rgba(255,255,255,.07);border-radius:14px;padding:12px 8px;text-align:center;cursor:pointer;border:3px solid transparent}
.cc:active{transform:scale(.95)}
.cc.sel{border-color:#ffd700;background:rgba(255,215,0,.12)}
.cc-av{width:50px;height:50px;border-radius:50%;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-size:26px;border:2px solid rgba(255,255,255,.25)}
.cc-n{font-size:11px;font-weight:700;color:#fff}
.cc-r{font-size:9px;color:rgba(255,255,255,.5);margin-top:2px}
.cp{margin-top:14px;padding:14px;background:rgba(255,255,255,.04);border-radius:14px}
.cp-top{display:flex;align-items:center;gap:14px;margin-bottom:12px}
.cp-av{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;border:2px solid rgba(255,255,255,.25)}
.cp-name{font-size:18px;font-weight:800;color:#fff}
.cp-role{font-size:12px;color:rgba(255,255,255,.5)}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.stat{display:flex;align-items:center;gap:6px;font-size:13px;color:rgba(255,255,255,.7)}
.stat-track{flex:1;height:8px;background:rgba(255,255,255,.12);border-radius:4px;overflow:hidden}
.stat-fill{height:100%;border-radius:4px}
.ab{background:rgba(155,89,182,.12);padding:12px;border-radius:10px;margin-bottom:8px}
.ab h5{font-size:12px;color:#b39ddb;margin-bottom:3px;font-weight:700}
.ab p{font-size:11px;color:rgba(255,255,255,.65)}
.sel-btn{width:100%;padding:14px;background:linear-gradient(135deg,#e74c3c,#27ae60);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;margin-top:12px}
.ag{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.ac{background:rgba(255,255,255,.07);border-radius:12px;padding:14px;text-align:center;cursor:pointer}
.ac:active{background:rgba(255,255,255,.14)}
.ac-icon{font-size:36px;margin-bottom:6px}
.ac-name{font-weight:700;font-size:12px;color:#fff}
.ghud{position:fixed;top:0;left:0;right:0;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,.8),transparent);display:none;z-index:100}
.ghud.show{display:block}
.g-title{font-size:18px;font-weight:800;color:#fff;text-align:center}
.g-time{font-size:56px;font-weight:900;color:#fff;text-align:center;line-height:1}
.g-time.warn{color:#ffe66d}
.g-time.danger{color:#ff6b6b;animation:tp .3s infinite}
@keyframes tp{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.g-tip{position:fixed;top:120px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);padding:10px 22px;border-radius:14px;color:#fff;font-size:13px;font-weight:600;text-align:center;max-width:90%;z-index:100;display:none}
.g-tip.show{display:block}
.sb{position:fixed;top:140px;left:10px;min-width:130px;border-radius:12px;overflow:hidden;display:none;z-index:100}
.sb.show{display:block}
.sb-h{background:linear-gradient(135deg,#e74c3c,#27ae60);padding:8px 12px;color:#fff;font-size:10px;font-weight:700;text-transform:uppercase}
.sb-b{background:rgba(15,25,45,.97);padding:6px;max-height:300px;overflow-y:auto}
.sb-r{display:flex;align-items:center;padding:7px 8px;border-radius:8px;margin-bottom:3px}
.sb-r.me{background:rgba(231,76,60,.25)}
.sb-r.top{background:rgba(255,215,0,.25)}
.sb-rk{width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;margin-right:8px;color:#fff}
.sb-r.top .sb-rk{background:#ffd700}
.sb-nm{flex:1;font-size:11px;font-weight:600;color:#fff}
.sb-sc{font-weight:800;font-size:13px;color:#fff}
.cd-scr{position:fixed;inset:0;background:rgba(15,25,45,.98);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:600}
.cd-scr.show{display:flex}
.cd-gn{font-size:28px;font-weight:800;color:#fff;margin-bottom:8px;text-align:center}
.cd-tip{font-size:14px;color:rgba(255,255,255,.65);margin-bottom:28px;text-align:center;padding:0 28px}
.cd-num{font-size:140px;font-weight:900;color:#fff;text-shadow:0 0 60px rgba(231,76,60,.7);line-height:1}
.cd-go{color:#4ecdc4;text-shadow:0 0 60px rgba(78,205,196,.7)}
.res{position:fixed;inset:0;background:linear-gradient(135deg,rgba(231,76,60,.96),rgba(39,174,96,.96));display:none;flex-direction:column;align-items:center;justify-content:center;z-index:700;padding:20px;overflow-y:auto}
.res.show{display:flex}
.res-t{font-size:40px;font-weight:900;color:#fff;margin-bottom:10px}
.res-s{font-size:14px;color:rgba(255,255,255,.8);margin-bottom:14px}
.pod{display:flex;align-items:flex-end;gap:10px;margin-bottom:16px}
.pod-s{display:flex;flex-direction:column;align-items:center}
.pod-av{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:6px;border:3px solid rgba(255,255,255,.5)}
.pod-n{color:#fff;font-weight:700;font-size:11px}
.pod-p{color:rgba(255,255,255,.8);font-size:10px;margin-bottom:6px}
.pod-b{width:60px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:#fff;border-radius:10px 10px 0 0}
.pod-s:nth-child(1) .pod-b{height:60px;background:#c0c0c0}
.pod-s:nth-child(2) .pod-b{height:85px;background:#ffd700}
.pod-s:nth-child(3) .pod-b{height:50px;background:#cd7f32}
.rew{display:flex;gap:10px;margin-bottom:14px}
.rew-c{padding:10px 18px;background:rgba(255,255,255,.18);border-radius:14px;color:#fff;font-weight:700;font-size:13px}
.res-btns{display:flex;gap:10px}
.res-btn{padding:14px 28px;font-size:14px;font-weight:800;border:none;border-radius:18px;cursor:pointer}
.res-btn:active{transform:scale(.95)}
.res-btn.pri{background:#fff;color:#e74c3c}
.res-btn.sec{background:rgba(255,255,255,.18);color:#fff}
.ld{position:fixed;inset:0;background:#0d1b2a;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .6s}
.ld.gone{opacity:0;pointer-events:none}
.ld-logo{font-size:70px;margin-bottom:14px}
.ld-title{font-size:36px;font-weight:900;color:#fff}
.ld-sub{font-size:11px;color:rgba(255,255,255,.4);letter-spacing:6px;margin-bottom:28px}
.ld-bar{width:240px;height:10px;background:rgba(255,255,255,.12);border-radius:5px;overflow:hidden}
.ld-fill{height:100%;background:linear-gradient(90deg,#e74c3c,#27ae60);border-radius:5px;width:0%}
.notifs{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:800;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.noti{padding:10px 20px;border-radius:12px;background:rgba(15,25,45,.95);display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;color:#fff;animation:nIn .25s ease;border:1px solid rgba(255,255,255,.1)}
@keyframes nIn{from{transform:translateY(-20px);opacity:0}}
.noti.ok{border-left:4px solid #4ecdc4}
.noti.bad{border-left:4px solid #ff6b6b}
.noti.inf{border-left:4px solid #3498db}
.particles{position:fixed;inset:0;pointer-events:none;z-index:1000;overflow:hidden}
.snow{position:absolute;color:#fff;animation:sf linear forwards;opacity:.8}
@keyframes sf{to{transform:translateY(105vh)}}
.stumble{position:fixed;inset:0;pointer-events:none;z-index:90;display:none}
.stumble.on{display:block;animation:st .35s ease}
@keyframes st{0%{background:radial-gradient(ellipse at center,rgba(255,0,0,.35),transparent)}100%{background:transparent}}
.speed{position:fixed;inset:0;pointer-events:none;z-index:88;background:radial-gradient(ellipse at center,transparent 20%,rgba(255,255,255,.15) 100%);display:none}
.speed.on{display:block}

.sb-rk{width:22px;height:22px;background:rgba(255,255,255,.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.sb-r.top .sb-rk{background:#ffd700;color:#000}
.sb-nm{flex:1;font-size:12px;font-weight:600;color:rgba(255,255,255,.9)}
.sb-sc{font-weight:800;color:#ffd700;font-size:13px}

/* Settings & Friend Styles */
.settings-btn { position: fixed; top: 10px; left: 10px; width: 44px; height: 44px; z-index: 1000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); border-radius: 50%; color: white; font-size: 24px; cursor: pointer; pointer-events: auto; }
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 8px; }
.setting-row label { color: #fff; font-size: 14px; }
.setting-row select, .setting-row input { background: #333; color: #fff; border: 1px solid #555; padding: 4px; border-radius: 4px; }
.preset-btn { flex: 1; padding: 10px; margin: 0 4px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; }
.p-classic { background: #555; }
.p-hd { background: #3498db; }
.p-deluxe { background: #f1c40f; color: #000; }
.friend-btn { padding: 4px 8px; background: #2ecc71; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; }
.friend-btn.added { background: #7f8c8d; }
</style>
</head>
<body>
<div class="vignette"></div>
<div id="SETBTN" class="settings-btn" onclick="show('SET')">‚öôÔ∏è</div>

<div id="SET" class="overlay">
  <div class="box">
    <div class="box-head">
      <button class="box-x" onclick="hide('SET')">√ó</button>
      <h2>Settings</h2>
      <p>Configure your experience</p>
    </div>
    <div class="box-body">
      <div style="display:flex; margin-bottom:15px;">
        <button class="preset-btn p-classic" onclick="setPreset('classic')">Classic</button>
        <button class="preset-btn p-hd" onclick="setPreset('hd')">HD</button>
        <button class="preset-btn p-deluxe" onclick="setPreset('deluxe')">Deluxe HD</button>
      </div>
      <div class="setting-row">
        <label>Graphics</label>
        <select id="sGraph" onchange="updSet()">
          <option value="classic">Classic</option>
          <option value="hd">HD</option>
          <option value="deluxe">Deluxe HD</option>
        </select>
      </div>
      <div class="setting-row">
        <label>Show Shadows</label>
        <input type="checkbox" id="sShadow" onchange="updSet()">
      </div>
      <div class="setting-row">
        <label>AI Difficulty</label>
        <select id="sAI" onchange="updSet()">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div class="setting-row">
        <label>Left Hand Mode</label>
        <input type="checkbox" id="sLeft" onchange="updSet()">
      </div>
    </div>
  </div>
</div>

<div class="ld" id="LD"><div class="ld-logo" id="ldLogo">üåÄ</div><div class="ld-title">RIFT RUCKUS</div><div class="ld-sub" id="ldSub">RIFT EDITION</div><div class="ld-bar"><div class="ld-fill" id="ldFill"></div></div></div>
<canvas id="C"></canvas>
<div id="hud">
<div class="hud-top">
<div class="panel player-info"><div class="avatar" id="hAvatar">üòé</div><div><div class="pname" id="hName">Player</div><div class="plevel">Lv.<span id="hLv">1</span></div></div></div>
<div class="coins"><div class="panel coin">üíé <span id="hGems">500</span></div><div class="panel coin">üëë <span id="hCrowns">10</span></div></div>
</div>
</div>
<div class="minimap" id="MM"><div class="mm-me"></div></div>
<div class="joy-area" id="joyL"><div class="joy-ring"></div><div class="joy-knob" id="knobL"></div><div class="joy-label">Move</div></div>
<div class="joy-area" id="joyR"><div class="joy-ring"></div><div class="joy-knob" id="knobR"></div><div class="joy-label">Look</div></div>
<div class="btns" id="BTNS">
<button class="btn btn-jump" id="bJump">ü¶ò<div class="btn-cd" id="cdJump"></div><span class="btn-label">Jump</span></button>
<button class="btn btn-grab" id="bGrab">ü§ú<div class="btn-cd" id="cdGrab"></div><span class="btn-label">Grab</span></button>
<button class="btn btn-skill" id="bSkill">‚ö°<div class="btn-cd" id="cdSkill"></div><span class="btn-label" id="lblSkill">Skill</span></button>
</div>
<div class="side-btns" id="SIDE">
<button class="side-btn emote-btn" id="bEmote">üòÑ</button>
<button class="side-btn sprint-btn" id="bSprint">üèÉ</button>
</div>
<div class="emote-pop" id="emPop"></div>
<div class="panel prompt" id="PROMPT"><span class="prompt-icon" id="prIcon">üåÄ</span><span class="prompt-text" id="prText">Enter</span><button class="prompt-go" id="prGo">Go</button></div>
<div class="indicator" id="IND"></div>
<div class="notifs" id="NOTIFS"></div>
<div class="particles" id="PARTS"></div>
<div class="stumble" id="STUMBLE"></div>
<div class="speed" id="SPEED"></div>

<div class="overlay" id="oPortal"><div class="box" style="position:relative"><button class="box-x" onclick="hide('oPortal')">√ó</button><div class="box-head"><h2>üéÑ Portal</h2><p>Choose mode</p></div><div class="box-body" id="modeList"></div></div></div>
<div class="overlay" id="oChar"><div class="box" style="position:relative"><button class="box-x" onclick="hide('oChar')">√ó</button><div class="box-head"><h2>üé≠ Runner</h2><p>Choose character</p></div><div class="box-body"><div class="cg" id="charGrid"></div><div class="cp" id="charPrev"></div></div></div></div>
<div class="overlay" id="oArcade"><div class="box" style="position:relative"><button class="box-x" onclick="hide('oArcade')">√ó</button><div class="box-head"><h2>üïπÔ∏è Practice</h2><p>Choose game</p></div><div class="box-body"><div class="ag" id="arcGrid"></div></div></div></div>

<div class="ghud" id="GHUD"><div class="g-title" id="gTitle">Game</div><div class="g-time" id="gTime">60</div></div>
<div class="g-tip" id="gTip"></div>
<div class="sb" id="SB"><div class="sb-h">Standings</div><div class="sb-b" id="sbBody"></div></div>
<div class="cd-scr" id="CDOWN"><div class="cd-gn" id="cdName">Game</div><div class="cd-tip" id="cdTip">Tip</div><div class="cd-num" id="cdNum">3</div></div>
<div class="res" id="RES"><div class="res-t" id="resT">Victory!</div><div class="res-s" id="resS"></div><div class="pod" id="resPod"></div><div class="rew" id="resRew"></div><div class="res-btns"><button class="res-btn pri" id="resNext">Continue</button><button class="res-btn sec" id="resAgain">Rematch</button></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ========== SAFE HELPERS ==========
const $=id=>document.getElementById(id);
const sMesh=(g,m)=>{const e=new THREE.Mesh(g,m);e.castShadow=e.receiveShadow=true;return e;};
const addMesh=(m,isLobby=false)=>{scene.add(m);(isLobby?lobbyMeshes:gameMeshes).push(m);};
const show=id=>{const e=$(id);if(e)e.classList.add('show');};
const hide=id=>{const e=$(id);if(e)e.classList.remove('show');};
const setText=(id,t)=>{const e=$(id);if(e)e.textContent=t;};
const rnd=(a,b)=>a+Math.random()*(b-a);
const shuffle=a=>[...a].sort(()=>Math.random()-.5);
const d2=(a,b)=>Math.sqrt((a.x-b.x)**2+(a.z-b.z)**2);
const d3=(a,b)=>Math.sqrt((a.x-b.x)**2+((a.y||0)-(b.y||0))**2+(a.z-b.z)**2);
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
function notify(msg,type='inf'){const c=$('NOTIFS');if(!c)return;const n=document.createElement('div');n.className='noti '+type;n.textContent=msg;c.appendChild(n);setTimeout(()=>{n.style.opacity='0';setTimeout(()=>n.remove(),200);},2200);}
function flash(id,ms){const e=$(id);if(e){e.classList.add('on');setTimeout(()=>e.classList.remove('on'),ms);}}

// ========== DATA ==========
const CHARS=[
{id:'glitch',name:'Glitch',emoji:'üòé',role:'Speed',color:0x5C6BC0,spd:90,pow:50,jmp:80,skill:'Blink',sType:'tele',sCD:5},
{id:'tank',name:'Harold',emoji:'ü¶£',role:'Tank',color:0x795548,spd:45,pow:95,jmp:40,skill:'Quake',sType:'stun',sCD:8},
{id:'sally',name:'Sally',emoji:'üêç',role:'Speed',color:0x26A69A,spd:95,pow:45,jmp:75,skill:'Dash',sType:'dash',sCD:4},
{id:'blob',name:'Blobby',emoji:'üü£',role:'Jump',color:0xEC407A,spd:65,pow:55,jmp:99,skill:'Bounce',sType:'jump',sCD:3},
{id:'santa',name:'Santa',emoji:'üéÖ',role:'All',color:0xE74C3C,spd:70,pow:70,jmp:70,skill:'Gift',sType:'buff',sCD:10}
];

const GAMES=[
{id:'stars',name:'‚≠ê Star Collector',tip:'Collect stars! Gold=30pts!',dur:50,type:'collect'},
{id:'sumo',name:'üí™ Sumo Ring',tip:'Push enemies out of the ring!',dur:55,type:'sumo'},
{id:'hill',name:'üëë King of Hill',tip:'Stay on hill to score! Knocked off after 5s!',dur:50,type:'hill'},
{id:'tag',name:'üè∑Ô∏è Tag Frenzy',tip:'GRAB to pass the tag! Don\'t be IT!',dur:45,type:'tag'},
{id:'pads',name:'ü™ë Musical Pads',tip:'Stand on GREEN pad when music stops!',dur:70,type:'pads'}
];

const IS_DEC = new Date().getMonth() === 11;
if(IS_DEC){
  const ll=$('ldLogo'); if(ll)ll.textContent='üéÑ';
  const ls=$('ldSub'); if(ls)ls.textContent='HOLIDAY EDITION';
}
const EMOTES=['üòÑ','üéÑ','üéÖ','‚õÑ','üéÅ','‚ùÑÔ∏è','üî•','üí™'];

// ========== STATE ==========
const ST={LOAD:0,LOBBY:1,CDOWN:2,GAME:3,RES:4};
let state=ST.LOAD;

let P={gems:500,crowns:10,charId:'glitch',score:0,isIt:false,tagImmune:0,
skillCD:0,grabCD:0,stunned:0,stamina:100,sprinting:false,hillTime:0,lv:1,xp:0,buffTime:0,
friends:[], preset:'hd', settings:{shadows:true, ai:'medium', leftHand:false}};

function saveData(){
  localStorage.setItem('RR_DATA', JSON.stringify({
    gems: P.gems, crowns: P.crowns, lv: P.lv, xp: P.xp, charId: P.charId,
    friends: P.friends, preset: P.preset, settings: P.settings
  }));
}

function loadData(){
  const d = localStorage.getItem('RR_DATA');
  if(d){
    try {
      const j = JSON.parse(d);
      Object.assign(P, j);
      setText('hGems', P.gems);
      setText('hLv', P.lv);
      if(P.settings.leftHand) {
        $('joyL').style.left='auto'; $('joyL').style.right='18px';
        $('joyR').style.right='auto'; $('joyR').style.left='18px';
        $('BTNS').style.right='auto'; $('BTNS').style.left='14px';
      }
    } catch (e) {
      console.error('Failed to load data from localStorage:', e);
      localStorage.removeItem('RR_DATA'); // Clear corrupted data
    }
  }

let selChar='glitch';
let scene,cam,ren,clk,sun;
var player,bots=[],lobbyMeshes=[],gameMeshes=[],stars=[],pads=[];
let solidPlatforms=[]; // {mesh, radius, topY}
let hillMesh=null; // {mesh, radius, topY}
let interacts=[];
const joy={l:{x:0,y:0},r:{x:0,y:0}};
let camAng=0,pVel={x:0,y:0,z:0},grounded=true,near=null;
let curGame=null,gTimer=0,gActive=false,rGames=[],rIdx=0;
let musicOn=true,padCount=16,scoreT=0;
let particles3d=[];
let shakeAmt=0;

const G=.03,SPD=.13,JMP=.4,FRC=.86;

function getC(id){return CHARS.find(c=>c.id===id)||CHARS[0];}
function curC(){return getC(P.charId);}

// ========== THREE SETUP ==========


function initThree(){
scene=new THREE.Scene();
const skyCol = P.preset === 'deluxe' ? 0xFFB74D : (IS_DEC ? 0x0a1a2a : 0x1a2a4a);
scene.background=new THREE.Color(skyCol);
scene.fog=new THREE.FogExp2(skyCol, P.preset === 'deluxe' ? .008 : .005);
cam=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,.1,800);
ren=new THREE.WebGLRenderer({canvas:$('C'),antialias:true});
ren.setSize(innerWidth,innerHeight);
ren.setPixelRatio(Math.min(devicePixelRatio, 2));
ren.shadowMap.enabled = P.settings.shadows;
ren.shadowMap.type = THREE.PCFSoftShadowMap; // Safer than VSM in headless
ren.toneMapping = THREE.ACESFilmicToneMapping;
ren.toneMappingExposure = P.preset === 'deluxe' ? 1.6 : 1.2;
clk=new THREE.Clock();
const ambInt = P.preset === 'deluxe' ? 1.0 : 0.5;
scene.add(new THREE.AmbientLight(0xFFE0B2, ambInt));
sun=new THREE.DirectionalLight(0xfff5e0, P.preset === 'deluxe' ? 1.8 : 1.1);
sun.position.set(80,120,80);
if(P.settings.shadows){
  sun.castShadow=true;
  const s=sun.shadow; s.mapSize.width=s.mapSize.height=(P.preset === 'deluxe' ? 2048 : 2048);
  s.camera.near=20; s.camera.far=400; s.camera.left=s.camera.bottom=-120; s.camera.right=s.camera.top=120;
}
scene.add(sun);
scene.add(new THREE.HemisphereLight(0x6699cc,0x334455,.5));
}
function mat(c,r=.5){
  if(P.preset === 'classic') return new THREE.MeshLambertMaterial({color:c});
  const m = new THREE.MeshStandardMaterial({color:c, roughness:r, metalness: (P.preset === 'deluxe' ? 0.2 : 0.1)});
  return m;
}




function makeChar(ch,isBot=false){
const g=new THREE.Group();
const col=ch.color;
const bm=mat(col,.35);
const body=sMesh(new THREE.CylinderGeometry(.4,.44,.7,12),bm);
body.position.y=1;body.castShadow=true;g.add(body);
const top=sMesh(new THREE.SphereGeometry(.4,12,10),bm);
top.position.y=1.35;top.castShadow=true;g.add(top);
const bot=sMesh(new THREE.SphereGeometry(.44,12,10),bm);
bot.position.y=.65;bot.castShadow=true;g.add(bot);
const head=sMesh(new THREE.SphereGeometry(.36,16,14),mat(0xFFDFC4,.45));
head.position.y=1.85;head.castShadow=true;g.add(head);
[-1,1].forEach(s=>{
  const eye=sMesh(new THREE.SphereGeometry(.07,8,6),mat(0x111111));
  eye.position.set(s*.12,1.9,.3);g.add(eye);
});

// Character specific details
if(ch.id==='glitch'){ // Panda style
  [-1,1].forEach(s=>{
    const ear=sMesh(new THREE.SphereGeometry(.12,8,8),mat(0x222222));
    ear.position.set(s*.25,2.15,0); g.add(ear);
    const patch=sMesh(new THREE.SphereGeometry(.1,8,8),mat(0x222222));
    patch.position.set(s*.12,1.9,.28); patch.scale.z=0.1; g.add(patch);
  });
} else if(ch.id==='tank'){ // Harold / Shiba style
  [-1,1].forEach(s=>{
    const ear=sMesh(new THREE.ConeGeometry(.15,.3,4),mat(col));
    ear.position.set(s*.22,2.15,0); ear.rotation.z=-s*0.3; g.add(ear);
  });
} else if(ch.id==='santa'){ // Piggy style
  const snout=sMesh(new THREE.CylinderGeometry(.12,.12,.1,12),mat(0xFFA07A));
  snout.position.set(0,1.82,.35); snout.rotation.x=Math.PI/2; g.add(snout);
}

const hat=sMesh(new THREE.ConeGeometry(.28,.45,8),mat(0xE74C3C,.4));
hat.position.y=2.2;hat.rotation.z=.12;g.add(hat);
if(isBot){
  const ant=sMesh(new THREE.CylinderGeometry(.015,.015,.28,6),mat(0x444444));
  ant.position.y=2.45;g.add(ant);
  const ball=sMesh(new THREE.SphereGeometry(.05,8,6),mat(0xFF4444));
  ball.position.y=2.55;g.add(ball);
}
return g;
}


// ========== LOBBY ==========


function addLobbyDeco(){
  // Balloons
  for(let i=0; i<12; i++){
    const a=(i/12)*Math.PI*2; const r=rnd(15,35);
    const b=sMesh(new THREE.SphereGeometry(.7,12,12), mat(Math.random()*0xffffff, .3));
    b.position.set(Math.cos(a)*r, 10+rnd(0,5), Math.sin(a)*r);
    b.userData={bob:true, baseY:b.position.y}; addMesh(b,true);
    const st=sMesh(new THREE.CylinderGeometry(.02,.02,15), mat(0xcccccc));
    st.position.set(b.position.x, b.position.y-7.5, b.position.z); addMesh(st,true);
  }
  // Bushes & Flowers
  for(let i=0; i<30; i++){
    const a=rnd(0, Math.PI*2); const r=rnd(10, 40);
    const x=Math.cos(a)*r, z=Math.sin(a)*r;
    if(d2({x,z}, {x:0,z:0}) < 18) continue; // Don't block plaza
    const b=sMesh(new THREE.SphereGeometry(rnd(.8, 1.5), 8, 8), mat(0x2E7D32, .8));
    b.position.set(x, 0.5, z); addMesh(b, true);
    if(Math.random() > 0.5){
      const f=sMesh(new THREE.SphereGeometry(.2, 8, 8), mat(Math.random()*0xffffff, .2));
      f.position.set(x+rnd(-.5,.5), 1.2, z+rnd(-.5,.5)); addMesh(f, true);
    }
  }
}
function buildLobby(){
lobbyMeshes.forEach(o=>scene.remove(o)); lobbyMeshes=[];
gameMeshes.forEach(o=>scene.remove(o)); gameMeshes=[];
interacts=[];
solidPlatforms=[];
if(IS_DEC){
const gnd=sMesh(new THREE.CircleGeometry(110,60),mat(0xE8F4F8,.8));
gnd.rotation.x=-Math.PI/2;addMesh(gnd,true);
const plazaR=18,plazaH=3;
const plaza=sMesh(new THREE.CylinderGeometry(plazaR,plazaR+2,plazaH,32),mat(0x6D4C41,.5));
plaza.position.y=plazaH/2;addMesh(plaza,true);
solidPlatforms.push({mesh:plaza,radius:plazaR+2,topY:plazaH});
buildXmasTree(0,plazaH,0);
buildPortal(0,0,-42); buildMirror(42,0,0); buildArcade(-42,0,0);
for(let i=0;i<30;i++){ const a=(i/30)*Math.PI*2+rnd(-.2,.2),r=55+rnd(0,45); buildPine(Math.cos(a)*r,Math.sin(a)*r); }
for(let i=0;i<8;i++){ const a=rnd(0,Math.PI*2),r=30+rnd(0,35); buildSnowman(Math.cos(a)*r,Math.sin(a)*r); }
for(let i=0;i<15;i++){ const a=rnd(0,Math.PI*2),r=24+rnd(0,50); buildPresent(Math.cos(a)*r,Math.sin(a)*r); }
for(let i=0;i<6;i++){ const a=(i/6)*Math.PI*2,r=30; buildLamp(Math.cos(a)*r,Math.sin(a)*r); }
}else{
const gnd=sMesh(new THREE.CircleGeometry(110,60),mat(0x388E3C));
gnd.rotation.x=-Math.PI/2;addMesh(gnd,true);
const plazaR=20,plazaH=1.5;
const plaza=sMesh(new THREE.CylinderGeometry(plazaR,plazaR,plazaH,32),mat(0xCFD8DC));
plaza.position.y=plazaH/2;addMesh(plaza,true);
solidPlatforms.push({mesh:plaza,radius:plazaR,topY:plazaH});
// Fountain
const f=new THREE.Group(); f.position.set(0,plazaH,0);
const fBase=sMesh(new THREE.CylinderGeometry(5,5,0.8,24),mat(0x90A4AE)); fBase.position.y=0.4; f.add(fBase);
const fMid=sMesh(new THREE.CylinderGeometry(1,1,3,16),mat(0x90A4AE)); fMid.position.y=2; f.add(fMid);
const fTop=sMesh(new THREE.CylinderGeometry(3,3,0.4,16),mat(0x90A4AE)); fTop.position.y=3.5; f.add(fTop);
const water=sMesh(new THREE.SphereGeometry(2.5,16,12,0,Math.PI*2,0,Math.PI/2),mat(0x29B6F6,.6));
water.position.y=3.5; f.add(water);
const lt=new THREE.PointLight(0x29B6F6,2,25); lt.position.y=5; f.add(lt);
addMesh(f,true);
buildPortal(0,0,-45); buildMirror(45,0,0); buildArcade(-45,0,0);
for(let i=0;i<40;i++){
const a=(i/40)*Math.PI*2+rnd(-.1,.1), r=45+rnd(0,55);
const x=Math.cos(a)*r, z=Math.sin(a)*r;
if(Math.random()>0.4){
const h=rnd(6,15);
const tree=new THREE.Group(); tree.position.set(x,0,z);
const tr=sMesh(new THREE.CylinderGeometry(.4,.6,h*.3,8),mat(0x5D4037)); tr.position.y=h*.15; tree.add(tr);
const leaf=sMesh(new THREE.ConeGeometry(rnd(3,5),h*.8,8),mat(0x2E7D32)); leaf.position.y=h*.5; tree.add(leaf);
addMesh(tree,true);
} else {
const rock=sMesh(new THREE.DodecahedronGeometry(rnd(2,4)),mat(0x9E9E9E));
rock.position.set(x,1,z); rock.rotation.set(rnd(0,6),rnd(0,6),rnd(0,6)); addMesh(rock,true);
}
}
}
}


function buildXmasTree(x,y,z){
const g=new THREE.Group();g.position.set(x,y,z);
const trunk=sMesh(new THREE.CylinderGeometry(1,1.5,3,10),mat(0x5D4037,.8));
trunk.position.y=1.5;trunk.castShadow=true;g.add(trunk);
for(let i=0;i<4;i++){
const layer=sMesh(new THREE.ConeGeometry(5.5-i*1,4.5,12),mat(0x2E7D32,.7));
layer.position.y=4.5+i*3;layer.castShadow=true;g.add(layer);
}
const star=sMesh(new THREE.OctahedronGeometry(1),mat(0xFFD700,.2));
star.position.y=18;star.userData.spin=true;g.add(star);
// Ornaments
for(let i=0;i<35;i++){
const orb=sMesh(new THREE.SphereGeometry(.3,10,8),mat([0xFF0000,0x0000FF,0xFFD700,0xFF69B4][i%4],.3));
const a=rnd(0,Math.PI*2),r=rnd(.8,4.5-i/10),h=4.5+rnd(0,10);
orb.position.set(Math.cos(a)*r,h,Math.sin(a)*r);g.add(orb);
}
scene.add(g);lobbyMeshes.push(g);
}

function buildPortal(x,y,z){
const g=new THREE.Group();g.position.set(x,y,z);
for(let i=0;i<3;i++){
const step=sMesh(new THREE.CylinderGeometry(8-i,8.5-i,.6,14),mat(0xE0E0E0,.3));
step.position.y=.3+i*.6;step.castShadow=true;g.add(step);
}
const ring=sMesh(new THREE.TorusGeometry(3,.6,10,20),mat(0x9C27B0,.3));
ring.position.y=5;ring.userData.spin=true;g.add(ring);
const orb=sMesh(new THREE.SphereGeometry(1.6,14,12),mat(0x00E5FF,.2));
orb.position.y=5;orb.userData.bob=true;orb.userData.baseY=5;g.add(orb);
g.userData={interact:true,type:'portal',text:'Enter Portal',icon:'üåÄ',r:12};
scene.add(g);lobbyMeshes.push(g);interacts.push(g);
}

function buildMirror(x,y,z){
const g=new THREE.Group();g.position.set(x,y,z);
const frame=sMesh(new THREE.BoxGeometry(5,7,.7),mat(0xFFD700,.2));
frame.position.y=4;frame.castShadow=true;g.add(frame);
const mirror=sMesh(new THREE.BoxGeometry(4.2,6,.15),new THREE.MeshStandardMaterial({color:0xE8EAF6,metalness:.95,roughness:.05}));
mirror.position.set(0,4,.45);g.add(mirror);
g.rotation.y=-Math.PI/2;
g.userData={interact:true,type:'char',text:'Choose Runner',icon:'üé≠',r:10};
scene.add(g);lobbyMeshes.push(g);interacts.push(g);
}

function buildArcade(x,y,z){
const g=new THREE.Group();g.position.set(x,y,z);
const body=sMesh(new THREE.BoxGeometry(5,6.5,3),mat(0x1A237E,.5));
body.position.y=3.25;body.castShadow=true;g.add(body);
const screen=sMesh(new THREE.BoxGeometry(3.5,2.5,.15),mat(0x00E676,.3));
screen.position.set(0,4.5,1.6);g.add(screen);
g.rotation.y=Math.PI/2;
g.userData={interact:true,type:'arcade',text:'Practice',icon:'üïπÔ∏è',r:10};
scene.add(g);lobbyMeshes.push(g);interacts.push(g);
}

function buildPine(x,z){
const g=new THREE.Group();g.position.set(x,0,z);
const h=rnd(7,13);
const trunk=sMesh(new THREE.CylinderGeometry(.4,.65,h*.3,8),mat(0x5D4037,.85));
trunk.position.y=h*.15;trunk.castShadow=true;g.add(trunk);
for(let i=0;i<3;i++){
const cone=sMesh(new THREE.ConeGeometry(2.5-i*.5,h*.22,10),mat(0x2E7D32,.7));
cone.position.y=h*.3+i*h*.18;cone.castShadow=true;g.add(cone);
}
const snow=sMesh(new THREE.ConeGeometry(1.2,.5,10),mat(0xFFFFFF,.8));
snow.position.y=h*.3+2*h*.18+.3;g.add(snow);
scene.add(g);lobbyMeshes.push(g);
}

function buildSnowman(x,z){
  const g=new THREE.Group();g.position.set(x,0,z);
  const sm=mat(0xFFFFFF,.75);
  const snowmanParts = [
    { radius: 1.2, segs: 14, rings: 12, y: 1.2 },
    { radius: 0.9, segs: 12, rings: 10, y: 2.8 },
    { radius: 0.65, segs: 10, rings: 8, y: 4.0 },
  ];
  snowmanParts.forEach(({ radius, segs, rings, y }) => {
    const sphere = sMesh(new THREE.SphereGeometry(radius, segs, rings), sm);
    sphere.position.set(0, y, 0);
    g.add(sphere);
  });
  const nose = sMesh(new THREE.ConeGeometry(.08,.45,6),mat(0xFF6600));
  nose.position.set(0,4,.65);nose.rotation.x=Math.PI/2;g.add(nose);
  scene.add(g);lobbyMeshes.push(g);
}

function buildPresent(x,z){
const g=new THREE.Group();g.position.set(x,0,z);
const s=rnd(.5,1);
const col=[0xFF0000,0x00FF00,0x0000FF,0xFF69B4][Math.floor(Math.random()*4)];
const box=sMesh(new THREE.BoxGeometry(s,s,s),mat(col,.4));
box.position.y=s/2;box.castShadow=true;g.add(box);
const rb=sMesh(new THREE.BoxGeometry(s*1.05,s*.1,s*1.05),mat(0xFFD700,.3));
rb.position.y=s/2;g.add(rb);
const bow=sMesh(new THREE.SphereGeometry(s*.2,8,6),mat(0xFFD700,.3));
bow.position.y=s+s*.1;g.add(bow);
scene.add(g);lobbyMeshes.push(g);
}

function buildLamp(x,z){
const g=new THREE.Group();g.position.set(x,0,z);
const pole=sMesh(new THREE.CylinderGeometry(.12,.18,5,8),mat(0x333333,.4));
pole.position.y=2.5;pole.castShadow=true;g.add(pole);
const lamp=sMesh(new THREE.SphereGeometry(.4,10,8),mat(0xFFE4B5,.25));
lamp.position.y=5.3;g.add(lamp);
const lt=new THREE.PointLight(0xFFE4B5,1.2,16);
lt.position.y=5.3;g.add(lt);
scene.add(g);lobbyMeshes.push(g);
}

// ========== PLAYER & BOTS ==========
function spawnPlayer(){
player=makeChar(curC(),false);
player.position.set(0,3.5,22);
scene.add(player);
}

function spawnBots(n){
bots.forEach(b=>scene.remove(b.mesh));bots=[];
const pool=CHARS.filter(c=>c.id!==P.charId);
for(let i=0;i<n;i++){
const ch=pool[i%pool.length];
const mesh=makeChar(ch,true);
const a=((i+1)/(n+1))*Math.PI*2,r=24+rnd(0,10);
mesh.position.set(Math.cos(a)*r,0,Math.sin(a)*r);
bots.push({
mesh,ch,name:ch.name,emoji:ch.emoji,color:ch.color,
score:0,isIt:false,tagImmune:0,stunned:0,
vel:{x:0,y:0,z:0},grounded:true,eliminated:false,
hillTime:0,target:null,aiTimer:0
});
scene.add(mesh);
}
}

// ========== GROUND / PHYSICS ==========
// THE key fix: ONE function determines ground height, no bouncing ever
function getGroundY(pos){
let gy=0;
// Lobby solids
if(true){ // Check solids always
solidPlatforms.forEach(sp=>{
const d=d2(pos,sp.mesh.position);
if(d<sp.radius) gy=Math.max(gy,sp.topY);
});
}
// Game hill
if(hillMesh){
const hd=d2(pos,hillMesh.mesh.position);
if(hd<hillMesh.radius) gy=Math.max(gy,hillMesh.topY);
}
return gy;
}

function applyPhysics(pos,vel){
// Gravity
if(!grounded) vel.y-=G;
// Move
pos.x+=vel.x;
pos.y+=vel.y;
pos.z+=vel.z;
// Ground
const gy=getGroundY(pos);
if(pos.y<=gy){
pos.y=gy;
vel.y=0;
grounded=true;
}else{
grounded=false;
}
// Friction
vel.x*=FRC;
vel.z*=FRC;
}

function applyBotPhysics(b){
if(!b.grounded) b.vel.y-=G;
b.mesh.position.x+=b.vel.x;
b.mesh.position.y+=b.vel.y;
b.mesh.position.z+=b.vel.z;
const gy=getGroundY(b.mesh.position);
if(b.mesh.position.y<=gy){
b.mesh.position.y=gy;
b.vel.y=0;
b.grounded=true;
}else b.grounded=false;
b.vel.x*=FRC;
b.vel.z*=FRC;
}

// ========== CONTROLS ==========
function initControls(){
mkJoy('joyL','knobL','l');
mkJoy('joyR','knobR','r');
const tap=(id,fn)=>{const e=$(id);if(!e)return;e.addEventListener('touchstart',ev=>{ev.preventDefault();ev.stopPropagation();fn();},{passive:false});e.addEventListener('click',ev=>{ev.preventDefault();fn();});};
tap('prGo',doInteract);
tap('bJump',doJump);
tap('bGrab',doGrab);
tap('bSkill',doSkill);
tap('bEmote',()=>$('emPop')?.classList.toggle('show'));
// Sprint hold
const sp=$('bSprint');
if(sp){
sp.addEventListener('touchstart',ev=>{ev.preventDefault();P.sprinting=true;sp.classList.add('on');},{passive:false});
sp.addEventListener('touchend',()=>{P.sprinting=false;sp.classList.remove('on');});
sp.addEventListener('touchcancel',()=>{P.sprinting=false;sp.classList.remove('on');});
}
// Emotes
const ep=$('emPop');
EMOTES.forEach(e=>{const b=document.createElement('button');b.textContent=e;b.onclick=()=>{notify(e);$('emPop')?.classList.remove('show');};ep?.appendChild(b);});
// Modal close
document.querySelectorAll('.overlay').forEach(o=>{o.addEventListener('click',ev=>{if(ev.target===o)o.classList.remove('show');});});
// Results
tap('resNext',()=>{hide('RES');if(rGames.length>0&&rIdx<rGames.length-1){rIdx++;setTimeout(()=>startMinigame(rGames[rIdx]),400);}else backToLobby();});
tap('resAgain',()=>{hide('RES');if(curGame)setTimeout(()=>startMinigame(curGame),300);else backToLobby();});
window.addEventListener('resize',()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();ren.setSize(innerWidth,innerHeight);});
}

function mkJoy(cId,kId,side){
const c=$(cId),k=$(kId);if(!c||!k)return;
const max=45;let cx=0,cy=0,tid=null;
c.addEventListener('touchstart',ev=>{ev.preventDefault();const t=ev.changedTouches[0];tid=t.identifier;const r=c.getBoundingClientRect();cx=r.left+r.width/2;cy=r.top+r.height/2;upd(t.clientX,t.clientY);},{passive:false});
c.addEventListener('touchmove',ev=>{ev.preventDefault();for(const t of ev.changedTouches)if(t.identifier===tid)upd(t.clientX,t.clientY);},{passive:false});
c.addEventListener('touchend',reset);c.addEventListener('touchcancel',reset);
function upd(tx,ty){let dx=tx-cx,dy=ty-cy;const d=Math.sqrt(dx*dx+dy*dy);if(d>max){dx=dx/d*max;dy=dy/d*max;}k.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;joy[side]={x:dx/max,y:dy/max};}
function reset(){tid=null;joy[side]={x:0,y:0};k.style.transform='translate(-50%,-50%)';}
}

// ========== ACTIONS ==========
function doJump(){
if(P.stunned>0||!grounded)return;
pVel.y=JMP*(curC().jmp/80);
grounded=false;
mkParts(player.position.x,.3,player.position.z,0xFFFFFF,12);
}



function doPush(){
  if(P.grabCD>0)return;
  P.grabCD=0.8;
  const targets = bots.filter(b=>!b.eliminated);
  let pushed=false;
  targets.forEach(b=>{
    const d = d3(player.position, b.mesh.position);
    if(d < 4.5){
      const dx = b.mesh.position.x - player.position.x;
      const dz = b.mesh.position.z - player.position.z;
      const mag = Math.sqrt(dx*dx+dz*dz) || 1;
      b.vel.x += (dx/mag)*0.6;
      b.vel.z += (dz/mag)*0.6;
      b.vel.y = 0.25;
      b.stunned = 1.2;
      pushed=true;
    }
  });
  if(pushed) { flash('bGrab', 200); mkParts(player.position.x, 1.5, player.position.z, 0xffffff, 10); }
}
function doGrab(){ doPush(); } // Legacy call support

function doSkill(){
if(P.skillCD>0||P.stunned>0)return;
if(state!==ST.GAME&&state!==ST.LOBBY)return;
const c=curC();
P.skillCD=c.sCD;cooldown('bSkill','cdSkill',c.sCD,'skillCD');
const fwd=new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0),player.rotation.y);
switch(c.sType){
case'tele':
  mkParts(player.position.x,1.5,player.position.z,0x00FFFF,20);
  player.position.add(fwd.clone().multiplyScalar(10));
  mkParts(player.position.x,1.5,player.position.z,0x00FFFF,30);
  break;
case'dash':
  pVel.x+=fwd.x*1.2;pVel.z+=fwd.z*1.2;
  flash('SPEED',500);
  mkParts(player.position.x,1,player.position.z,0x4ECDC4,25);
  break;
case'jump':
  pVel.y=.7;grounded=false;
  mkParts(player.position.x,.3,player.position.z,0xFF69B4,25);
  break;
case'stun':
  bots.forEach(b=>{if(d3(player.position,b.mesh.position)<12){b.stunned=2.5;b.vel.y=.2;mkParts(b.mesh.position.x,1.5,b.mesh.position.z,0xFFD700,20);showEmoji(b.mesh,'üí´');}});
  shakeAmt=.8;
  const ring=sMesh(new THREE.TorusGeometry(1,.2,8,32),mat(0xFFD700,.1));
  ring.position.copy(player.position); ring.rotation.x=Math.PI/2;
  scene.add(ring);
  let rStart=Date.now();
  const rAni=()=>{
    let age=(Date.now()-rStart)/600;
    if(age>=1){scene.remove(ring);return;}
    ring.scale.set(1+age*15, 1+age*15, 1);
    ring.material.opacity=1-age;
    requestAnimationFrame(rAni);
  };
  rAni();
  break;
case'buff':
  P.buffTime=5;
  notify('POWER UP!','ok');
  flash('SPEED',5000);
  mkParts(player.position.x,2,player.position.z,0xFF0000,30);
  break;
}
notify(c.skill+'!','inf');
showEmoji(player, c.emoji);
}

function cooldown(btnId,cdId,dur,prop){
const btn=$(btnId);if(btn)btn.classList.add('cd');
let rem=dur;
const iv=setInterval(()=>{
rem-=.1;const cd=$(cdId);if(cd)cd.textContent=Math.max(0,Math.ceil(rem));
if(rem<=0){clearInterval(iv);P[prop]=0;if(btn)btn.classList.remove('cd');}
},100);
}

function doInteract(){
if(!near)return;
const t=near.userData.type;
if(t==='portal'){show('oPortal');loadModes();}
else if(t==='char'){show('oChar');loadChars();}
else if(t==='arcade'){show('oArcade');loadArcade();}
$('PROMPT')?.classList.remove('show');
}

// ========== UI LOADERS ==========
function loadModes(){
const el=$('modeList');if(!el)return;
el.innerHTML='<div class="ml" id="mList"></div>';
const ml=$('mList');
[{name:'‚ö° Quick',desc:'1 random game',cnt:1},{name:'üéâ Party',desc:'3 games',cnt:3}].forEach(m=>{
const c=document.createElement('div');c.className='mc';
c.innerHTML=`<span class="mc-icon">${m.name.split(' ')[0]}</span><div class="mc-info"><h4>${m.name}</h4><p>${m.desc}</p></div>`;
c.onclick=()=>{hide('oPortal');rGames=shuffle(GAMES).slice(0,m.cnt);rIdx=0;setTimeout(()=>startMinigame(rGames[0]),300);};
ml.appendChild(c);
});
}

function loadChars(){
const grid=$('charGrid');if(!grid)return;
grid.innerHTML='';
CHARS.forEach(c=>{
const card=document.createElement('div');
card.className='cc'+(c.id===selChar?' sel':'');
card.innerHTML=`<div class="cc-av" style="background:#${c.color.toString(16).padStart(6,'0')}">${c.emoji}</div><div class="cc-n">${c.name}</div><div class="cc-r">${c.role}</div>`;
card.onclick=()=>{selChar=c.id;loadChars();previewChar(c);};
grid.appendChild(card);
});
previewChar(getC(selChar));
}

function previewChar(c){
const el=$('charPrev');if(!el)return;
el.innerHTML=`<div class="cp-top"><div class="cp-av" style="background:#${c.color.toString(16).padStart(6,'0')}">${c.emoji}</div><div><div class="cp-name">${c.name}</div><div class="cp-role">${c.role}</div></div></div>
<div class="stats"><div class="stat">‚ö°<div class="stat-track"><div class="stat-fill" style="width:${c.spd}%;background:#4ecdc4"></div></div></div><div class="stat">üí™<div class="stat-track"><div class="stat-fill" style="width:${c.pow}%;background:#ff6b6b"></div></div></div><div class="stat">ü¶ò<div class="stat-track"><div class="stat-fill" style="width:${c.jmp}%;background:#f1c40f"></div></div></div></div>
<div class="ab"><h5>‚ö° ${c.skill} (${c.sCD}s)</h5><p>Special ability</p></div>
<button class="sel-btn" id="selBtn">Play as ${c.name}</button>`;
$('selBtn').onclick=()=>{P.charId=c.id;updatePlayerMesh();hide('oChar');notify('Playing as '+c.name+'!','ok');};
}

function updatePlayerMesh(){
const pos=player.position.clone(),rot=player.rotation.y;
scene.remove(player);
player=makeChar(curC(),false);
player.position.copy(pos);player.rotation.y=rot;
scene.add(player);
setText('hAvatar',curC().emoji);
setText('lblSkill',curC().skill);
}

function loadArcade(){
const grid=$('arcGrid');if(!grid)return;
grid.innerHTML='';
GAMES.forEach(g=>{
const card=document.createElement('div');card.className='ac';
card.innerHTML=`<div class="ac-icon">${g.name.split(' ')[0]}</div><div class="ac-name">${g.name.substring(g.name.indexOf(' ')+1)}</div>`;
card.onclick=()=>{hide('oArcade');curGame=g;setTimeout(()=>startMinigame(g),300);};
grid.appendChild(card);
});
}

function updInd(){
const el=$('IND');if(!el)return;
if(curGame?.type==='tag'){
el.textContent=P.isIt?'üè∑Ô∏è YOU ARE IT!':'üè∑Ô∏è IT: '+(bots.find(b=>b.isIt)?.name||'?');
el.classList.add('show');
}else if(curGame?.type==='pads'){
el.textContent=musicOn?'üéµ Running...':'‚ö†Ô∏è FIND GREEN PAD!';
el.classList.add('show');
}else el.classList.remove('show');
}

// ========== SNOW ==========
function startSnow(){
setInterval(()=>{
if(state===ST.LOAD)return;
const f=document.createElement('div');f.className='snow';
f.textContent=['‚ùÑ','‚ùÖ','‚ùÜ'][Math.floor(Math.random()*3)];
f.style.left=rnd(0,100)+'vw';f.style.fontSize=rnd(10,22)+'px';
f.style.animationDuration=rnd(5,9)+'s';
$('PARTS')?.appendChild(f);
setTimeout(()=>f.remove(),9000);
},220);
}

// ========== LOADING ==========

function updSet(){
  P.settings.shadows = $('sShadow').checked;
  P.settings.ai = $('sAI').value;
  P.settings.leftHand = $('sLeft').checked;
  P.preset = $('sGraph').value;
  saveData();
  // Apply immediately or reload
  if(confirm("Settings updated. Reload to apply?")) location.reload();
}
function setPreset(p){
  P.preset = p;
  if(p==='classic') { P.settings.shadows=false; }
  else { P.settings.shadows=true; }
  $('sGraph').value = p;
  $('sShadow').checked = P.settings.shadows;
  saveData();
  location.reload();
}

function startLoad(){
let p=0;
const iv=setInterval(()=>{
p+=rnd(16,28);if(p>100)p=100;
const fill=$('ldFill');if(fill)fill.style.width=p+'%';
if(p>=100){clearInterval(iv);setTimeout(()=>{$('LD')?.classList.add('gone');state=ST.LOBBY;},500);}
},130);
}

// ========== MINIGAME START ==========
function startMinigame(game){
state=ST.CDOWN;curGame=game;scoreT=0;musicOn=true;padCount=16;hillMesh=null;
$('hud').style.display='none';
$('MM')?.classList.remove('show');
$('PROMPT')?.classList.remove('show');
$('SIDE').style.display='flex';
// Hide grab for non-applicable
const gb=$('bGrab');if(gb)gb.classList.toggle('hidden',game.type==='collect'||game.type==='pads');
lobbyMeshes.forEach(o=>o.visible=false);
player.visible=false;bots.forEach(b=>b.mesh.visible=false);
solidPlatforms=[];
buildArena(game);
// Countdown
setText('cdName',game.name);setText('cdTip',game.tip);
show('CDOWN');
let cnt=3;setText('cdNum','3');$('cdNum').className='cd-num';
const iv=setInterval(()=>{
cnt--;
if(cnt>0)setText('cdNum',cnt);
else if(cnt===0){setText('cdNum','GO!');$('cdNum').className='cd-num cd-go';}
else{clearInterval(iv);hide('CDOWN');beginGame();}
},900);
}


function beginGame(){
state=ST.GAME;gActive=true;gTimer=curGame.dur;
show('GHUD');setText('gTitle',curGame.name);
show('SB');
$('BTNS').style.display='flex';
const tip=$('gTip');if(tip){tip.textContent='üí° '+curGame.tip;tip.classList.add('show');setTimeout(()=>tip.classList.remove('show'),3500);}
P.score=0;P.isIt=false;P.tagImmune=0;P.stamina=100;P.hillTime=0;P.sprinting=false;
bots.forEach(b=>{b.score=0;b.isIt=false;b.tagImmune=0;b.eliminated=false;b.mesh.visible=true;b.stunned=0;b.hillTime=0;b.aiTimer=0;});
if(curGame.type==='tag'){
const it=bots[Math.floor(Math.random()*bots.length)];
it.isIt=true;it.tagImmune=4;
updInd();
}
if(curGame.type==='pads'){resetPads();updInd();}
updateSB();
const tEl=$('gTime');
const iv=setInterval(()=>{
if(!gActive){clearInterval(iv);return;}
gTimer--;
if(tEl){tEl.textContent=Math.max(0,gTimer);tEl.className='g-time';if(gTimer<=10)tEl.classList.add('danger');else if(gTimer<=20)tEl.classList.add('warn');}
if(curGame?.type==='pads'&&gTimer%11===0&&gTimer>0&&gTimer<curGame.dur){
musicOn=!musicOn;
if(!musicOn){padCount=Math.max(2,padCount-2);notify('üéµ MUSIC STOPPED!','inf');setTimeout(()=>checkPads(),1200);}
else{notify('üéµ Playing!','inf');resetPads();}
updInd();
}
if(gTimer<=0){clearInterval(iv);endMinigame();}
},1000);
}


function showEmoji(parent, text){
const canvas = document.createElement('canvas');
canvas.width = 128; canvas.height = 128;
const ctx = canvas.getContext('2d');
ctx.font = '80px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
ctx.fillText(text, 64, 64);
const tex = new THREE.CanvasTexture(canvas);
const smat = new THREE.SpriteMaterial({map: tex, transparent: true});
const sprite = new THREE.Sprite(smat);
sprite.position.y = 3.2; sprite.scale.set(2, 2, 2);
parent.add(sprite);
let start = Date.now();
const ani = () => {
  let age = (Date.now() - start) / 2000;
  if(age >= 1) { parent.remove(sprite); return; }
  sprite.position.y = 3.2 + age * 1.5;
  sprite.material.opacity = 1 - age;
  requestAnimationFrame(ani);
};
ani();
}

function buildArenaScenery(){
const R=120;
for(let i=0;i<20;i++){
const a=(i/20)*Math.PI*2+rnd(-.2,.2), r=R+rnd(0,60);
const x=Math.cos(a)*r, z=Math.sin(a)*r;
const g=new THREE.Group(); g.position.set(x,0,z);
if(Math.random()>0.5){
const h=rnd(8,20);
const tr=sMesh(new THREE.CylinderGeometry(.5,.8,h*.2,8),mat(0x5D4037)); tr.position.y=h*.1; g.add(tr);
for(let j=0;j<3;j++){
const leaf=sMesh(new THREE.ConeGeometry(5-j,h*.4,10),mat(0x2E7D32));
leaf.position.y=h*.3+j*h*.25; g.add(leaf);
}
} else {
const s=rnd(3,7);
const rock=sMesh(new THREE.DodecahedronGeometry(s),mat(0x757575));
rock.position.y=s*.6; rock.rotation.set(rnd(0,6),rnd(0,6),rnd(0,6)); g.add(rock);
}
addMesh(g,false);
}
}

// ========== ARENA BUILDER ==========
function buildArena(game){
lobbyMeshes.forEach(o=>scene.remove(o)); lobbyMeshes=[];
gameMeshes.forEach(o=>scene.remove(o)); gameMeshes=[];
stars=[];pads=[];hillMesh=null;solidPlatforms=[];
const bgMap={collect:0x0D47A1,sumo:0x3E2723,hill:0xBF360C,tag:0x01579B,pads:0x4A148C};
scene.background=new THREE.Color(bgMap[game.type]||0x1a2a4a);
scene.fog=new THREE.FogExp2(bgMap[game.type]||0x1a2a4a,.004);
buildArenaScenery();
const R=game.type==='sumo'?50:85;
// Ground
const gnd=sMesh(new THREE.CircleGeometry(R,60),mat({collect:0x2E7D32,sumo:0x5D4037,hill:0xBF360C,tag:0x006064,pads:0x4A148C}[game.type]||0x2E7D32,.8));
gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addMesh(gnd,false);
// Border
const bor=sMesh(new THREE.TorusGeometry(R,1.5,10,60),mat(0xFFD700,.4));
bor.rotation.x=Math.PI/2;bor.position.y=.75;addMesh(bor,false);
// Game-specific
if(game.type==='collect')for(let i=0;i<55;i++)spawnStar();
if(game.type==='hill'){
buildHill();
for(let i=0;i<4;i++){ const a=(i/4)*Math.PI*2, r=40, x=Math.cos(a)*r, z=Math.sin(a)*r; const p=sMesh(new THREE.CylinderGeometry(8,8,4,16),mat(0xBF360C)); p.position.set(x,2,z); addMesh(p); solidPlatforms.push({mesh:p,radius:8,topY:4}); }
}
if(game.type==='pads')buildPadGrid();
if(game.type==='tag'){
for(let i=0;i<8;i++){ const a=(i/8)*Math.PI*2, r=30, x=Math.cos(a)*r, z=Math.sin(a)*r; const p=sMesh(new THREE.BoxGeometry(6,12,6),mat(0x006064)); p.position.set(x,6,z); addMesh(p); solidPlatforms.push({mesh:p,radius:4,topY:12}); }
}
if(game.type==='sumo'){
for(let i=0;i<6;i++){ const a=(i/6)*Math.PI*2+rnd(-.3,.3),r=12+rnd(0,10); const p=sMesh(new THREE.DodecahedronGeometry(rnd(3,5)),mat(0x5D4037)); p.position.set(Math.cos(a)*r,2,Math.sin(a)*r); p.rotation.set(rnd(0,6),rnd(0,6),rnd(0,6)); addMesh(p); solidPlatforms.push({mesh:p,radius:4,topY:4}); }
}
// Players
player.visible=true;player.position.set(0,0,28);pVel={x:0,y:0,z:0};grounded=true;
bots.forEach((b,i)=>{
b.mesh.visible=true;b.eliminated=false;
const a=((i+1)/(bots.length+1))*Math.PI*2,r=22+rnd(0,10);
b.mesh.position.set(Math.cos(a)*r,0,Math.sin(a)*r);
b.vel={x:0,y:0,z:0};b.stunned=0;b.grounded=true;
});
}

function buildHill(){
const mesh=sMesh(new THREE.CylinderGeometry(16,20,10,32),mat(0xFFD700,.35));
mesh.position.y=4;mesh.castShadow=true;mesh.receiveShadow=true;
scene.add(mesh);gameMeshes.push(mesh);
hillMesh={mesh,radius:14,topY:8};
const crown=sMesh(new THREE.ConeGeometry(3,4,5),mat(0xFFD700,.2));
crown.position.y=11;crown.userData.spin=true;crown.userData.bob=true;crown.userData.baseY=11;
scene.add(crown);gameMeshes.push(crown);
}

function buildPadGrid(){
const sz=4,sp=12,off=-(sz-1)*sp/2;
for(let x=0;x<sz;x++){
for(let z=0;z<sz;z++){
const pad=sMesh(new THREE.CylinderGeometry(6,6.5,1.5,16),mat(0x9C27B0,.35));
pad.position.set(off+x*sp,.6,off+z*sp);
pad.userData={active:true,idx:x*sz+z};
scene.add(pad);gameMeshes.push(pad);pads.push(pad);
}
}
}

function resetPads(){
pads.forEach(p=>{p.userData.active=true;p.material.color.setHex(0x9C27B0);p.position.y=.6;});
const toOff=pads.length-padCount;
const sh=shuffle([...pads]);
for(let i=0;i<toOff;i++){sh[i].userData.active=false;sh[i].material.color.setHex(0x333333);sh[i].position.y=-.5;}
pads.filter(p=>p.userData.active).forEach(p=>p.material.color.setHex(0x00FF00));
}


function checkPads(){
const activePads = pads.filter(p=>p.userData.active);
const participants = [
{id:'player', pos:player.position, obj:P, name:'You'},
...bots.filter(b=>!b.eliminated).map(b=>({id:b.name, pos:b.mesh.position, obj:b, name:b.name}))
];
const winners = new Set();
const padOccupant = new Map();
participants.forEach(p => {
  let bestPad = null, bestD = 5;
  activePads.forEach(pad => {
    const d = d2(p.pos, pad.position);
    if(d < bestD) { bestPad = pad; bestD = d; }
  });
  if(bestPad) {
    if(!padOccupant.has(bestPad) || padOccupant.get(bestPad).dist > bestD) {
      padOccupant.set(bestPad, {p, dist: bestD});
    }
  }
});
padOccupant.forEach((v, pad) => {
  winners.add(v.p.id);
  pad.material.color.setHex(0x4444FF);
});
if(winners.has('player')){ P.score+=25; notify('Safe! +25','ok'); }
else { P.score=Math.max(0,P.score-40); flash('STUMBLE',350); notify('No pad! -40','bad'); }
bots.forEach(b => {
  if(b.eliminated) return;
  if(winners.has(b.name)) b.score+=25;
  else b.score=Math.max(0,b.score-40);
});
setTimeout(()=>{musicOn=true;resetPads();updInd();},2000);
}


function spawnStar(){
const gold=Math.random()<.12;
const val=gold?30:10;
const shape=new THREE.Shape();
for(let i=0;i<10;i++){const r=i%2===0?.8:.38,a=(i/10)*Math.PI*2-Math.PI/2;if(i===0)shape.moveTo(Math.cos(a)*r,Math.sin(a)*r);else shape.lineTo(Math.cos(a)*r,Math.sin(a)*r);}
shape.closePath();
const mesh=sMesh(new THREE.ExtrudeGeometry(shape,{depth:.35,bevelEnabled:false}),mat(gold?0xFFD700:0xFFFF00,.3));
if(gold)mesh.scale.setScalar(1.5);
const a=rnd(0,Math.PI*2),r=rnd(10,60);
mesh.position.set(Math.cos(a)*r,2.5,Math.sin(a)*r);
mesh.rotation.x=Math.PI/2;
mesh.userData={val,off:rnd(0,Math.PI*2)};
scene.add(mesh);gameMeshes.push(mesh);stars.push(mesh);
}

// ========== BOT AI ==========


function runBotAI(dt){
const spd_base=SPD*.7*(curGame?.type==='pads'?.6:1)*(curGame?.type==='sumo'?.7:1)*(P.settings.ai==='hard'?1.2:P.settings.ai==='easy'?0.7:1);
bots.forEach((b,idx)=>{
if(b.eliminated){b.mesh.visible=true;return;}
if(b.stunned>0){b.stunned-=dt;return;}
if(b.tagImmune>0)b.tagImmune-=dt;

// Learning: Check if fell
if(b.mesh.position.y < -5) {
  b.mem.bad.push({x: b.mesh.position.x, z: b.mesh.position.z});
  if(b.mem.bad.length > 10) b.mem.bad.shift();
  b.mesh.position.set(0, 5, 0); b.vel.set(0,0,0);
}

b.aiTimer-=dt;
if(b.aiTimer<=0){
b.aiTimer=rnd(.3,1);
// AI Logic...

b.aiTimer=rnd(.3,1);
if(curGame?.type==='collect'){
let best=null,bestD=Infinity;
stars.forEach(s=>{if(!s.userData.taken){const dd=d3(b.mesh.position,s.position);if(dd<bestD){bestD=dd;best=s;}}});
if(best)b.target={x:best.position.x,z:best.position.z};
}else if(curGame?.type==='hill'){
b.target={x:rnd(-5,5),z:rnd(-5,5)};
}else if(curGame?.type==='tag'){
if(b.isIt){
let best=null,bestD=Infinity;
if(!P.isIt&&P.tagImmune<=0){const dd=d2(b.mesh.position,player.position);if(dd<bestD){bestD=dd;best=player.position;}}
bots.forEach(o=>{if(o!==b&&!o.isIt&&!o.eliminated&&o.tagImmune<=0){const dd=d2(b.mesh.position,o.mesh.position);if(dd<bestD){bestD=dd;best=o.mesh.position;}}});
if(best)b.target={x:best.x,z:best.z};
}else{
const it=bots.find(o=>o.isIt)||(P.isIt?player:null);
if(it){
const pos=it.position||it.mesh?.position;
if(pos){const dx=b.mesh.position.x-pos.x,dz=b.mesh.position.z-pos.z,dd=Math.sqrt(dx*dx+dz*dz);
if(dd>.1)b.target={x:b.mesh.position.x+(dx/dd)*22,z:b.mesh.position.z+(dz/dd)*22};}
}
}
}else if(curGame?.type==='pads'&&!musicOn){
const active=pads.filter(p=>p.userData.active);
if(active.length>0){const pad=active[idx%active.length];b.target={x:pad.position.x,z:pad.position.z};}
}else if(curGame?.type==='sumo'){
if(Math.random()>.4){b.target={x:player.position.x,z:player.position.z};}
else{const o=bots.filter(x=>x!==b&&!x.eliminated);if(o.length){const t=o[Math.floor(Math.random()*o.length)];b.target={x:t.mesh.position.x,z:t.mesh.position.z};}}
}else b.target={x:rnd(-35,35),z:rnd(-35,35)};
}
if(b.target){
const dx=b.target.x-b.mesh.position.x,dz=b.target.z-b.mesh.position.z,dd=Math.sqrt(dx*dx+dz*dz);
if(dd>1.2){
const s=spd_base*(b.ch.spd/80);
b.mesh.position.x+=(dx/dd)*s;
b.mesh.position.z+=(dz/dd)*s;
b.mesh.rotation.y=Math.atan2(dx,dz);
}
}
if(state===ST.GAME && !b.isIt && Math.random() < 0.02) {
  const targets = [player, ...bots.filter(o=>o!==b)];
  targets.forEach(t => {
    const tPos = t.position || t.mesh.position;
    if(d3(b.mesh.position, tPos) < 4) {
      const dx=tPos.x-b.mesh.position.x, dz=tPos.z-b.mesh.position.z, dd=Math.sqrt(dx*dx+dz*dz);
      if(t === player) { pVel.x+=(dx/dd)*0.4; pVel.z+=(dz/dd)*0.4; pVel.y=0.15; P.stunned=0.4; flash('STUMBLE', 300); }
      else { t.vel.x+=(dx/dd)*0.4; t.vel.z+=(dz/dd)*0.4; t.vel.y=0.15; t.stunned=0.4; }
      mkParts(tPos.x, 1.5, tPos.z, 0xFFFFFF, 10);
    }
  });
}
applyBotPhysics(b);
const bd=d2(b.mesh.position,{x:0,z:0});
const sumoR = (curGame?.type==='sumo'?28:70);
if(bd>sumoR){
if(curGame?.type==='sumo'){b.score=Math.max(0,b.score-50);const a=rnd(0,Math.PI*2);b.mesh.position.set(Math.cos(a)*15,0,Math.sin(a)*15);}
else{b.mesh.position.x*=sumoR/bd;b.mesh.position.z*=sumoR/bd;}
}
stars.forEach(s=>{
if(!s.userData.taken&&d3(b.mesh.position,s.position)<3){
s.userData.taken=true;scene.remove(s);b.score+=s.userData.val;
if(state===ST.GAME) setTimeout(()=>spawnStar(),4000);
}
});
if(curGame?.type==='tag'&&b.isIt&&b.tagImmune<=0){
if(!P.isIt&&P.tagImmune<=0&&d3(b.mesh.position,player.position)<3){
b.isIt=false;P.isIt=true;P.tagImmune=3;
notify('‚ö†Ô∏è YOU\'RE IT! -50','bad'); P.score=Math.max(0,P.score-50); b.score+=100; updInd();
}
bots.forEach(o=>{
if(o!==b&&!o.isIt&&!o.eliminated&&o.tagImmune<=0&&d3(b.mesh.position,o.mesh.position)<3){
b.isIt=false;o.isIt=true;o.tagImmune=3;b.score+=100;o.score=Math.max(0,o.score-50);updInd();
}
});
}
if(curGame?.type==='hill'&&hillMesh){
const hd=d2(b.mesh.position,{x:0,z:0});
if(hd<hillMesh.radius&&b.mesh.position.y>=hillMesh.topY-.5){
b.hillTime=(b.hillTime||0)+dt;
if(b.hillTime>=1){b.score+=1;b.hillTime-=1;}
if(b.hillTime>=5){ const a=rnd(0,Math.PI*2); b.vel.x+=Math.cos(a)*.5; b.vel.z+=Math.sin(a)*.5; b.vel.y=.25; b.hillTime=0; }
}else b.hillTime=0;
}
});
}



function updateMinigame(dt){
if(!gActive)return;
if(P.tagImmune>0)P.tagImmune-=dt;
if(!P.sprinting&&P.stamina<100)P.stamina=Math.min(100,P.stamina+22*dt);
scoreT+=dt;
if(P.buffTime>0)P.buffTime-=dt;
const t=Date.now()*.001;
gameMeshes.forEach(o=>{
if(o.userData.bob)o.position.y=(o.userData.baseY||4)+Math.sin(t*2)*.5;
if(curGame?.type==='hill' && o.geometry.type==='ConeGeometry') o.scale.setScalar(1+Math.sin(t*5)*0.1);
if(o.userData.spin)o.rotation.y+=dt;
});
stars.forEach(s=>{
if(!s.userData.taken){
s.position.y=2.5+Math.sin(t*3+s.userData.off)*.5;
s.rotation.z+=dt*5;
if(d3(player.position,s.position)<3){
s.userData.taken=true;scene.remove(s);
P.score+=s.userData.val;
mkParts(s.position.x,s.position.y,s.position.z,0xFFD700,18);
if(state===ST.GAME) setTimeout(()=>spawnStar(),4000);
}
}
});
if(curGame?.type==='hill'&&hillMesh){
const hd=d2(player.position,{x:0,z:0});
if(hd<hillMesh.radius&&player.position.y>=hillMesh.topY-.5){
P.hillTime+=dt;
if(P.hillTime>=1){P.score+=1;P.hillTime-=1;}
if(P.hillTime>=5){ P.stunned=0;
const a=rnd(0,Math.PI*2); pVel.x+=Math.cos(a)*.6; pVel.z+=Math.sin(a)*.6; pVel.y=.3;
P.hillTime=0; notify('Knocked off!','inf'); mkParts(player.position.x,1.5,player.position.z,0xFFD700,20);
}
}else P.hillTime=0;
}
if(curGame?.type==='sumo'){
if(scoreT>=1){ if(!P.isIt)P.score+=1; bots.forEach(b=>{if(!b.isIt&&!b.eliminated)b.score+=1;}); scoreT=0; }
const pd=d2(player.position,{x:0,z:0});
const sumoR = (curGame?.type==='sumo'?28:70);
if(pd>sumoR){P.score=Math.max(0,P.score-50);player.position.set(0,0,0);flash('STUMBLE',350);}
if(gTimer < curGame.dur - 10) {
  const shrink = 1 - (curGame.dur - 10 - gTimer) / 100;
  const currentR = Math.max(15, 40 * shrink);
  if(gameMeshes[0]) gameMeshes[0].scale.set(currentR/40, 1, currentR/40);
  if(gameMeshes[1]) gameMeshes[1].scale.set(currentR/40, 1, currentR/40);
  if(pd > currentR) { P.score=Math.max(0,P.score-50); player.position.set(0,0,0); flash('STUMBLE',350); }
  bots.forEach(b => { if(!b.eliminated && d2(b.mesh.position,{x:0,z:0}) > currentR) { b.score=Math.max(0,b.score-50); b.mesh.position.set(0,0,0); } });
}
}
if(curGame?.type==='tag'){
const pd=d2(player.position,{x:0,z:0});
if(pd>70){player.position.x*=70/pd;player.position.z*=70/pd;}
if(P.isIt&&P.tagImmune<=0){
bots.forEach(b=>{
if(!b.isIt&&!b.eliminated&&b.tagImmune<=0&&d3(player.position,b.mesh.position)<3){
P.isIt=false;b.isIt=true;b.tagImmune=3;P.tagImmune=2;
notify('Tagged '+b.name+'! +100','ok'); P.score+=100; b.score=Math.max(0,b.score-50);updInd();
}
});
}
}
if(curGame?.type==='pads'){
  if(musicOn){
    const pd=d2(player.position,{x:0,z:0});
    if(pd>70){player.position.x*=70/pd;player.position.z*=70/pd;}
  }
}
if(curGame?.type==='collect'){
  const pd=d2(player.position,{x:0,z:0});
  if(pd>70){player.position.x*=70/pd;player.position.z*=70/pd;}
}
runBotAI(dt);
updateSB();
updateMM();
}


function getAllScores(){
return[{name:'You',score:Math.floor(P.score),emoji:curC().emoji,color:curC().color,isPlayer:true,isIt:P.isIt},
...bots.map(b=>({name:b.name,score:Math.floor(b.score),emoji:b.emoji,color:b.color,isPlayer:false,isIt:b.isIt,eliminated:b.eliminated}))
].sort((a,b)=>b.score-a.score);
}

function updateSB(){
const body=$('sbBody');if(!body)return;
body.innerHTML='';
getAllScores().slice(0,10).forEach((e,i)=>{
const d=document.createElement('div');
d.className='sb-r'+(e.isPlayer?' me':'')+(i===0?' top':'');
d.innerHTML=`<span class="sb-rk">${i+1}</span><span class="sb-nm">${e.emoji} ${e.name}${e.isIt?' üè∑Ô∏è':''}</span><span class="sb-sc">${e.score}</span>`;
body.appendChild(d);
});
}

function updateMM(){
const mm=$('MM');if(!mm)return;
mm.classList.add('show');
mm.querySelectorAll('.mm-dot').forEach(d=>d.remove());
bots.forEach(b=>{
if(b.eliminated)return;
const dx=b.mesh.position.x-player.position.x,dz=b.mesh.position.z-player.position.z;
if(Math.abs(dx)<60&&Math.abs(dz)<60){
const dot=document.createElement('div');
dot.className='mm-dot bot'+(b.isIt?' it':'');
dot.style.left=(50+dx*.65)+'px';
dot.style.top=(50+dz*.65)+'px';
mm.appendChild(dot);
}
});
}

function endMinigame(){
gActive=false;state=ST.RES;
hide('GHUD');hide('SB');hide('IND');
$('BTNS').style.display='none';
showResults();
}


function addFriend(name, btn){
  if(!P.friends.includes(name)) { P.friends.push(name); saveData(); }
  btn.textContent = 'Friends ‚úÖ'; btn.classList.add('added'); btn.disabled=true;
}

function showResults(){
const scores=getAllScores();
const rank=scores.findIndex(s=>s.isPlayer)+1;
const won=rank===1;
setText('resT',won?'üéâ VICTORY!':rank<=3?'ü•à Nice!':'Try Again');
setText('resS',`#${rank} ‚Äî ${P.score} pts`);
const pod=$('resPod');if(pod){
pod.innerHTML='';
const order=[scores[1],scores[0],scores[2]],places=[2,1,3];
order.forEach((e,i)=>{
if(!e)return;
const isFriend = P.friends.includes(e.name);
const d=document.createElement('div');d.className='pod-s';
d.innerHTML=`<div class="pod-av" style="background:#${e.color.toString(16).padStart(6,'0')}">${e.emoji}</div><div class="pod-n">${e.name}</div><div class="pod-p">${e.score}</div><div class="pod-b">${places[i]}</div>` +
(e.isPlayer ? '' : `<button class="friend-btn ${isFriend?'added':''}" onclick="addFriend('${e.name}', this)">${isFriend?'Friends ‚úÖ':'Add Friend'}</button>`);
pod.appendChild(d);
});
}
const shards=won?180:50+rank*15;
P.gems+=shards;
setText('hGems',P.gems);
const rr=$('resRew');if(rr)rr.innerHTML=`<div class="rew-c">üíé +${shards}</div>`;
show('RES');
if(won)for(let i=0;i<50;i++)setTimeout(()=>{
const c=document.createElement('div');c.className='snow';c.textContent=(IS_DEC?['üéâ','üéä','‚≠ê','üéÑ','üéÖ']:['üéâ','üéä','‚≠ê','üíé','üèÜ'])[Math.floor(Math.random()*5)];c.style.left=rnd(0,100)+'vw';c.style.fontSize='24px';c.style.animationDuration=rnd(3,5)+'s';$('PARTS')?.appendChild(c);setTimeout(()=>c.remove(),5000);
},i*40);
const next=$('resNext');if(next)next.textContent=rGames.length>0&&rIdx<rGames.length-1?'Next Game':'Continue';
}

function backToLobby(){
state=ST.LOBBY;curGame=null;rGames=[];rIdx=0;hillMesh=null;
hide('RES');
$('hud').style.display='block';
hide('IND');
$('SIDE').style.display='none';
$('bGrab')?.classList.remove('hidden');
scene.background=new THREE.Color(0x1a2a4a);
scene.fog=new THREE.FogExp2(0x1a2a4a,.005);
buildLobby();
player.visible=true;player.position.set(0,3.5,22);pVel={x:0,y:0,z:0};
bots.forEach((b,i)=>{b.mesh.visible=true;b.eliminated=false;const a=((i+1)/(bots.length+1))*Math.PI*2;b.mesh.position.set(Math.cos(a)*24,0,Math.sin(a)*24);});
}

// ========== PARTICLES ==========
function mkParts(x,y,z,col,n){
for(let i=0;i<n;i++){
const m=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.9});
const p=sMesh(new THREE.SphereGeometry(.15,8,6),m);
p.position.set(x,y,z);
p.userData={vx:rnd(-.5,.5),vy:rnd(.2,.55),vz:rnd(-.5,.5),life:1,m};
scene.add(p);particles3d.push(p);
}
}

// ========== MAIN LOOP ==========
function animate(){
requestAnimationFrame(animate);
const dt=Math.min(clk.getDelta(),.05);
const t=Date.now()*.001;
if(true){ // Check solids always
// Player movement - smooth, no bounce
const c=curC();
const inp=joy.l;
const sprint=P.sprinting?1.4:1;
const spd=SPD*(c.spd/80)*sprint*0.75; // Rebalanced speed
const mag=Math.sqrt(inp.x**2+inp.y**2);
if(mag>.1){
const ang=Math.atan2(inp.x,inp.y)+camAng;
pVel.x+=Math.sin(ang)*mag*spd*.12;
pVel.z+=Math.cos(ang)*mag*spd*.12;
player.rotation.y=ang;
}
applyPhysics(player.position,pVel);
// Boundary
const pd=d2(player.position,{x:0,z:0});
if(pd>100){player.position.x*=100/pd;player.position.z*=100/pd;}
// Camera
if(Math.abs(joy.r.x)>.1)camAng-=joy.r.x*.035;
// Interact check
let closest=null,closestD=Infinity;
interacts.forEach(o=>{const dd=d3(player.position,o.position);if(dd<(o.userData.r||10)&&dd<closestD){closestD=dd;closest=o;}});
near=closest;
const prompt=$('PROMPT');
if(near && !document.querySelector('.overlay.show')){
setText('prIcon',near.userData.icon);setText('prText',near.userData.text);
prompt?.classList.add('show');
}else prompt?.classList.remove('show');
// Minimap
updateMM();
// Animate lobby
lobbyMeshes.forEach(o=>{if(o.userData?.spin)o.rotation.y+=dt;if(o.userData?.bob)o.position.y=(o.userData.baseY||4)+Math.sin(t*2)*.4;});
bots.forEach((b,i)=>{
if(Math.random()<.01||!b.target)b.target={x:rnd(-40,40),z:rnd(-40,40)};
const dx=b.target.x-b.mesh.position.x,dz=b.target.z-b.mesh.position.z,dd=Math.sqrt(dx*dx+dz*dz);
if(dd>1.5){b.mesh.position.x+=(dx/dd)*.05;b.mesh.position.z+=(dz/dd)*.05;b.mesh.rotation.y=Math.atan2(dx,dz);}
});
}else if(state===ST.GAME){
// Game player movement
if(gActive&&P.stunned<=0){
const c=curC();
const inp=joy.l;
const sprint=(P.sprinting&&P.stamina>0?1.4:1)*(P.buffTime>0?1.3:1);
if(P.sprinting&&P.stamina>0)P.stamina=Math.max(0,P.stamina-dt*30);
const spd=SPD*(c.spd/80)*sprint*.55*(curGame?.type==='pads'?!musicOn?0.15:0.7:1);
const mag=Math.sqrt(inp.x**2+inp.y**2);
if(mag>.1){
const ang=Math.atan2(inp.x,inp.y)+camAng;
pVel.x+=Math.sin(ang)*mag*spd;
pVel.z+=Math.cos(ang)*mag*spd;
player.rotation.y=ang;
}
if(Math.abs(joy.r.x)>.1)camAng-=joy.r.x*.035;
if(P.sprinting&&mag>.3)flash('SPEED',80);
}else if(P.stunned>0)P.stunned-=dt;
applyPhysics(player.position,pVel);
updateMinigame(dt);
}
// Particles
for(let i=particles3d.length-1;i>=0;i--){
const p=particles3d[i];
p.position.x+=p.userData.vx;p.position.y+=p.userData.vy;p.position.z+=p.userData.vz;
p.userData.vy-=.025;p.userData.life-=dt*4;
if(p.userData.m)p.userData.m.opacity=p.userData.life;
if(p.userData.life<=0){scene.remove(p);particles3d.splice(i,1);}
}
// Camera
const tX=player.position.x+Math.sin(camAng)*22;
const tZ=player.position.z+Math.cos(camAng)*22;
const tY=player.position.y+16;
cam.position.x+=(tX-cam.position.x)*.12;
cam.position.y+=(tY-cam.position.y)*.12;
cam.position.z+=(tZ-cam.position.z)*.12;
if(shakeAmt>0){cam.position.x+=rnd(-shakeAmt,shakeAmt);cam.position.y+=rnd(-shakeAmt,shakeAmt);shakeAmt*=.8;if(shakeAmt<.01)shakeAmt=0;}
cam.lookAt(player.position.x,player.position.y+2.5,player.position.z);
if(sun){sun.position.set(player.position.x+80,120,player.position.z+80);sun.target.position.copy(player.position);sun.target.updateMatrixWorld();}
ren.render(scene,cam);
}

// ========== INIT ==========
loadData(); initThree();
buildLobby();
spawnPlayer();
spawnBots(5);
initControls();
if(IS_DEC) startSnow();
startLoad();

// ========== DEBUG SYSTEM ==========
window.DEBUG = {
  gotoLobby: () => backToLobby(),
  start: (id) => {
    let g; if(typeof id === "number") g = GAMES[id]; else g = GAMES.find(x => x.id === id);
    if(g) startMinigame(g);
    else console.error("Game not found:", id);
  },
  show: (id) => show(id),
  setGems: (n) => { P.gems = n; setText('hGems', n); },
  setLv: (n) => { P.lv = n; setText('hLv', n); }
};

animate();
</script>
</body>
  </html>
