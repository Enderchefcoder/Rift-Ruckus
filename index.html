<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>RIFT RUCKUS</title>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#f2f20d",
                    "background-light": "#f8f8f5",
                    "background-dark": "#181811",
                    "card-dark": "#2a2a1e",
                },
                fontFamily: {
                    "display": ["Spline Sans", "sans-serif"]
                },
                borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
            },
        },
    }
</script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-user-select:none;user-select:none}
    html,body{overflow:hidden;height:100%;width:100%; font-family: 'Spline Sans', sans-serif;}
    canvas{display:block;width:100vw;height:100vh;position:fixed;top:0;left:0}
    .vignette{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:50;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,.45) 100%)}

    .joy-area{position:fixed;bottom:25px;width:120px;height:120px;z-index:200}
    #joyL{left:18px}
    #joyR{right:18px}
    .joy-ring{position:absolute;width:100%;height:100%;border-radius:50%;background:rgba(255,255,255,.08);border:3px solid rgba(255,255,255,.2)}
    .joy-knob{position:absolute;width:52px;height:52px;border-radius:50%;background:linear-gradient(145deg,#fff,#ccc);box-shadow:0 4px 18px rgba(0,0,0,.5);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
    .joy-label{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:600;color:rgba(255,255,255,.6);text-transform:uppercase}

    .btn{width:58px;height:58px;border-radius:50%;border:none;font-size:24px;cursor:pointer;position:relative;box-shadow:0 4px 18px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
    .btn:active{transform:scale(.85)}
    .btn.hidden{display:none!important}
    .btn-jump{background:linear-gradient(145deg,#3498db,#2980b9)}
    .btn-grab{background:linear-gradient(145deg,#e74c3c,#c0392b)}
    .btn-skill{background:linear-gradient(145deg,#9b59b6,#8e44ad)}
    .btn-cd{position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#fff}
    .btn.cd .btn-cd{display:flex}
    .btn.cd{opacity:.4}

    .side-btn{width:46px;height:46px;border-radius:50%;border:none;font-size:18px;cursor:pointer;box-shadow:0 3px 14px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
    .emote-btn{background:linear-gradient(145deg,#f1c40f,#d4ac0d)}
    .sprint-btn{background:linear-gradient(145deg,#7f8c8d,#616a6b)}
    .sprint-btn.on{background:linear-gradient(145deg,#2ecc71,#27ae60)}

    .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:500;display:none;align-items:center;justify-content:center;padding:16px}
    .overlay.show{display:flex}

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .material-symbols-outlined.filled {
      font-variation-settings: 'FILL' 1;
    }

    /* Google Emoji Utility */
    .g-emoji {
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        display: inline-block;
        vertical-align: middle;
    }
</style>
</head>
<body class="bg-background-dark font-display antialiased selection:bg-primary selection:text-black text-white">
<div class="vignette"></div>
<div id="fps" style="position:fixed;top:10px;right:10px;color:white;font-family:monospace;z-index:2000;display:none;"></div>
<div id="NOTIFS" style="position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none;"></div>
<div id="PARTS" style="position:fixed;inset:0;pointer-events:none;z-index:400;overflow:hidden;"></div>
<div id="IND" class="fixed top-[120px] left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-md px-6 py-2 rounded-full border border-white/10 text-white font-black text-sm tracking-widest hidden z-[150]"></div>

<div id="fps" style="position:fixed;top:10px;right:10px;color:white;font-family:monospace;z-index:2000;display:none;"></div>
<div id="hud" class="fixed top-0 left-0 right-0 p-4 z-[100] pointer-events-none flex items-start justify-between">
    <div class="flex items-center gap-3 bg-black/40 backdrop-blur-md p-2 pl-2 pr-4 rounded-full border border-white/10 pointer-events-auto" onclick="show('oChar')">
        <div class="size-10 rounded-full bg-gradient-to-br from-primary to-yellow-600 flex items-center justify-center text-xl shadow-lg border border-white/20" id="hAvatar">üòé</div>
        <div class="flex flex-col">
            <span class="text-white font-bold text-xs leading-none" id="hName">Runner</span>
            <span class="text-primary font-black text-[10px] tracking-widest uppercase">Lv.<span id="hLv">1</span></span>
        </div>
    </div>

    <div class="flex gap-2 pointer-events-auto">
        <div class="bg-black/40 backdrop-blur-md px-3 py-2 rounded-2xl border border-white/10 flex items-center gap-2">
            <span class="text-sm">üíé</span>
            <span class="text-white font-bold text-xs" id="hGems">0</span>
        </div>
        <button class="bg-black/40 backdrop-blur-md size-10 rounded-full border border-white/10 flex items-center justify-center text-white hover:text-primary transition-colors" onclick="show('oSettings')">
            <span class="material-symbols-outlined text-xl">settings</span>
        </button>
    </div>
</div>
<div class="coins"><div class="panel coin">üíé <span id="hGems">500</span></div><div class="panel coin">üëë <span id="hCrowns">10</span></div></div>
</div>
</div>
<div class="minimap" id="MM"><div class="mm-me"></div></div>
<div class="joy-area" id="joyL"><div class="joy-ring"></div><div class="joy-knob" id="knobL"></div><div class="joy-label">Move</div></div>
<div class="joy-area" id="joyR"><div class="joy-ring"></div><div class="joy-knob" id="knobR"></div><div class="joy-label">Look</div></div>
<div class="btns" id="BTNS">
<button class="btn btn-jump" id="bJump">ü¶ò<div class="btn-cd" id="cdJump"></div><span class="btn-label">Jump</span></button>
<button class="btn btn-grab" id="bGrab">ü§ú<div class="btn-cd" id="cdGrab"></div><span class="btn-label">Grab</span></button>
<button class="btn btn-skill" id="bSkill">‚ö°<div class="btn-cd" id="cdSkill"></div><span class="btn-label" id="lblSkill">Skill</span></button>
</div>
<div class="side-btns" id="SIDE">
<button class="side-btn emote-btn" id="bEmote">üòÑ</button>
<button class="side-btn sprint-btn" id="bSprint">üèÉ</button>
</div>
<div class="fixed bottom-[320px] right-4 bg-background-dark/95 backdrop-blur-md border border-white/10 p-2 rounded-2xl hidden z-[250]" id="emPop">
    <div class="grid grid-cols-4 gap-2" id="emoteGrid"></div>
</div>
<div class="panel prompt" id="PROMPT"><span class="prompt-icon" id="prIcon">üåÄ</span><span class="prompt-text" id="prText">Enter</span><button class="prompt-go" id="prGo">Go</button></div>
<div class="indicator" id="IND"></div>
<div class="notifs" id="NOTIFS"></div>
<div class="particles" id="PARTS"></div>
<div class="stumble" id="STUMBLE"></div>
<div class="speed" id="SPEED"></div>

<div class="overlay" id="oPortal">
<div class="relative flex h-full max-h-[70vh] w-full flex-col overflow-hidden max-w-md mx-auto bg-background-dark shadow-2xl rounded-3xl border border-white/10 text-white">
<header class="flex items-center justify-between p-6 pt-8 pb-4 shrink-0">
<button class="text-white hover:text-primary transition-colors flex items-center justify-center size-10 rounded-full bg-white/5" onclick="hide('oPortal')">
<span class="material-symbols-outlined text-xl">close</span>
</button>
<h1 class="text-xl font-bold">JUMP INTO RIFT</h1>
<div class="size-10"></div>
</header>
<main class="flex-1 px-6 pb-8 overflow-y-auto scrollbar-hide" id="modeList">
<!-- Modes -->
</main>
</div>
</div>
<div class="overlay" id="oChar">
<div class="relative flex h-full max-h-[90vh] w-full flex-col overflow-hidden max-w-md mx-auto bg-background-dark shadow-2xl rounded-3xl border border-white/10 text-white">
<header class="flex items-center justify-between p-6 pt-8 pb-4 z-10 shrink-0">
<button class="text-white hover:text-primary transition-colors flex items-center justify-center size-10 rounded-full bg-white/5 backdrop-blur-sm" onclick="hide('oChar')">
<span class="material-symbols-outlined text-xl">arrow_back</span>
</button>
<h1 class="text-xl font-bold tracking-tight">Select Runner</h1>
<button class="text-white hover:text-primary transition-colors flex items-center justify-center size-10 rounded-full bg-white/5 backdrop-blur-sm" onclick="hide('oChar'); show('oSettings')">
<span class="material-symbols-outlined text-xl">settings</span>
</button>
</header>
<main class="flex-1 flex flex-col px-6 pb-24 overflow-y-auto scrollbar-hide">
<div class="grid grid-cols-3 gap-4 mb-8" id="charList">
<!-- Dynamic Content -->
</div>
<div id="charDetail" class="flex flex-col items-center animate-in slide-in-from-bottom-4 duration-500">
<!-- Dynamic Detail -->
</div>
</main>
<div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-background-dark via-background-dark/95 to-transparent z-20">
<button id="btnPlayAs" class="w-full bg-primary hover:bg-[#d9d90c] active:scale-[0.98] transition-all text-black font-bold text-lg py-4 px-6 rounded-full shadow-[0_4px_20px_rgba(242,242,13,0.25)] flex items-center justify-center gap-2">
<span>Select Runner</span>
<span class="material-symbols-outlined">check</span>
</button>
</div>
</div>
</div></div>
<div class="overlay" id="oArcade"><div class="box" style="position:relative"><button class="box-x" onclick="hide('oArcade')">√ó</button><div class="box-head"><h2>üïπÔ∏è Practice</h2><p>Choose game</p></div><div class="box-body"><div class="ag" id="arcGrid"></div></div></div></div>

<div class="overlay" id="oSocial">
  <div class="box">
    <div class="box-head">
      <button class="close-btn" onclick="hide('oSocial')">√ó</button>
      <h2>Friends & Social</h2>
      <p>Invite your friended bots!</p>
    </div>
    <div class="box-body" id="socialList">
    </div>
  </div>
</div>

<div class="ghud" id="GHUD"><div class="g-title" id="gTitle">Game</div><div class="g-time" id="gTime">60</div></div>
<div class="g-tip" id="gTip"></div>
<div class="sb" id="SB"><div class="sb-h">Standings</div><div class="sb-b" id="sbBody"></div></div>
<div class="cd-scr" id="CDOWN"><div class="cd-gn" id="cdName">Game</div><div class="cd-tip" id="cdTip">Tip</div><div class="cd-num" id="cdNum">3</div></div>
<div class="res" id="RES"><div class="res-t" id="resT">Victory!</div><div class="res-s" id="resS"></div><div class="pod" id="resPod"></div><div class="rew" id="resRew"></div><div class="res-btns"><button class="res-btn pri" id="resNext">Continue</button><button class="res-btn sec" id="resAgain">Rematch</button></div></div>



<div class="ld fixed inset-0 bg-background-dark z-[1000] flex flex-col items-center justify-center transition-all duration-700" id="LD">
    <div class="ld-logo text-6xl mb-4 animate-bounce" id="ldLogo">üåÄ</div>
    <div class="ld-title text-4xl font-black italic tracking-tighter text-white mb-1">RIFT RUCKUS</div>
    <div class="ld-sub text-primary text-xs font-black tracking-[0.3em] uppercase mb-8" id="ldSub">RIFT EDITION</div>
    <div class="w-64 h-1.5 bg-white/10 rounded-full overflow-hidden">
        <div class="ld-fill h-full bg-primary transition-all duration-300" id="ldFill" style="width:0%"></div>
    </div>
</div>

<canvas id="C"></canvas>

<div class="fixed top-20 right-4 w-24 h-24 bg-black/40 backdrop-blur-md border border-white/10 rounded-2xl hidden z-90 overflow-hidden" id="MM">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 size-2 bg-primary rounded-full shadow-[0_0_8px_#f2f20d] border border-white z-10"></div>
</div>

<div class="joy-area" id="joyL"><div class="joy-ring"></div><div class="joy-knob" id="knobL"></div><div class="joy-label">Move</div></div>
<div class="joy-area" id="joyR"><div class="joy-ring"></div><div class="joy-knob" id="knobR"></div><div class="joy-label">Look</div></div>

<div class="btns fixed bottom-[160px] right-4 flex gap-4 z-[200]" id="BTNS">
    <button class="btn btn-jump" id="bJump">ü¶ò<div class="btn-cd" id="cdJump"></div></button>
    <button class="btn btn-grab" id="bGrab">ü§ú<div class="btn-cd" id="cdGrab"></div></button>
    <button class="btn btn-skill" id="bSkill">‚ú®<div class="btn-cd" id="cdSkill"></div></button>
</div>

<div class="side-btns fixed bottom-[280px] right-4 flex flex-col gap-3 z-[200]" id="SIDE" style="display:none">
    <button class="side-btn emote-btn" id="bEmote">üé≠</button>
    <button class="side-btn sprint-btn" id="bSprint">‚ö°</button>
</div>

<div class="fixed top-4 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-md px-6 py-3 rounded-2xl border border-white/10 hidden z-[150]" id="GHUD">
    <div class="flex flex-col items-center">
        <div class="text-white font-black italic text-lg leading-tight" id="gTitle">GAME</div>
        <div class="text-primary font-black text-2xl" id="gTime">00</div>
    </div>
</div>

<div class="fixed top-[80px] left-4 bg-black/40 backdrop-blur-md p-3 rounded-2xl border border-white/10 hidden z-[90] min-w-[140px]" id="SB">
    <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-2 border-b border-white/5 pb-1">Leaderboard</div>
    <div id="sbBody" class="space-y-1"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>

const $=id=>document.getElementById(id);
const sMesh=(g,m)=>{const e=new THREE.Mesh(g,m);e.castShadow=e.receiveShadow=true;return e;};
const addMesh=(m,isLobby=false)=>{scene.add(m);(isLobby?lobbyMeshes:gameMeshes).push(m);};
const show=id=>{const e=$(id);if(e)e.classList.add('show');};
const hide=id=>{const e=$(id);if(e)e.classList.remove('show');};
const setText=(id,t)=>{const e=$(id);if(e)e.textContent=t;};
const rnd=(a,b)=>a+Math.random()*(b-a);
const shuffle=a=>[...a].sort(()=>Math.random()-.5);
const d2=(a,b)=>Math.sqrt((a.x-b.x)**2+(a.z-b.z)**2);
const d3=(a,b)=>Math.sqrt((a.x-b.x)**2+((a.y||0)-(b.y||0))**2+(a.z-b.z)**2);
const getGvEmoji = e => `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50%' x='50%' dy='.35em' text-anchor='middle' font-size='80'>${e}</text></svg>`;
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
function notify(msg,type='inf'){const c=$('NOTIFS');if(!c)return;const n=document.createElement('div');n.className='noti '+type;n.textContent=msg;c.appendChild(n);setTimeout(()=>{n.style.opacity='0';setTimeout(()=>n.remove(),200);},2200);}
function flash(id,ms){const e=$(id);if(e){e.classList.add('on');setTimeout(()=>e.classList.remove('on'),ms);}}

const CHARS=[
{id:'glitch',name:'Glitch',emoji:'üòé',role:'Speed',color:0x5C6BC0,spd:90,pow:50,jmp:80,skill:'Blink',sType:'tele',sCD:5},
{id:'tank',name:'Harold',emoji:'ü¶£',role:'Tank',color:0x795548,spd:45,pow:95,jmp:40,skill:'Quake',sType:'stun',sCD:8},
{id:'sally',name:'Sally',emoji:'üêç',role:'Speed',color:0x26A69A,spd:95,pow:45,jmp:75,skill:'Dash',sType:'dash',sCD:4},
{id:'blob',name:'Blobby',emoji:'üü£',role:'Jump',color:0xEC407A,spd:65,pow:55,jmp:99,skill:'Bounce',sType:'jump',sCD:3},
{id:'santa',name:'Santa',emoji:'üéÖ',role:'All',color:0xE74C3C,spd:70,pow:70,jmp:70,skill:'Gift',sType:'buff',sCD:10},
{id:'ninja',name:'Ninja',emoji:'ü•∑',role:'Stealth',color:0x212121,spd:85,pow:60,jmp:90,skill:'Smoke',sType:'smoke',sCD:6}
];

const GAMES=[
{id:'stars',name:'‚≠ê Star Collector',tip:'Collect stars! Gold=30pts!',dur:50,type:'collect'},
{id:'sumo',name:'üí™ Sumo Ring',tip:'Push enemies out of the ring!',dur:55,type:'sumo'},
{id:'hill',name:'üëë King of Hill',tip:'Stay on hill to score! Knocked off after 5s!',dur:50,type:'hill'},
{id:'tag',name:'üè∑Ô∏è Tag Frenzy',tip:"GRAB to pass the tag! Don't be IT!",dur:45,type:'tag'},
{id:'pads',name:'ü™ë Musical Pads',tip:'Stand on GREEN pad when music stops!',dur:70,type:'pads'}
];

const month = new Date().getMonth();
const IS_DEC = month === 11;
const IS_OCT = month === 9;
const IS_SPRING = month >= 2 && month <= 4;

const EMOTES=['üòÑ','ü§£','üòé','ü•∑','üî•','üëë','üí™','üåü'];

const ST={LOAD:0,LOBBY:1,CDOWN:2,GAME:3,RES:4};
let state=ST.LOAD;

let P={gems:500,crowns:10,charId:'glitch',score:0,isIt:false,tagImmune:0,
skillCD:0,grabCD:0,stunned:0,stamina:100,sprinting:false,hillTime:0,lv:1,xp:0,buffTime:0,
friends:[], invited:[], preset:'hd', settings:{shadows:true, ai:'medium', leftHand:false, acc:false, debug:false}};

function saveData(){
  localStorage.setItem('RR_DATA', JSON.stringify({
    gems: P.gems, crowns: P.crowns, lv: P.lv, xp: P.xp, charId: P.charId,
    friends: P.friends, invited: P.invited, preset: P.preset, settings: P.settings
  }));
}

function loadData(){
  const d = localStorage.getItem('RR_DATA');
  if(d){
    try {
        const j = JSON.parse(d);
        if(j.settings) Object.assign(P.settings, j.settings);
        if(j.friends) P.friends = j.friends;
        if(j.invited) P.invited = j.invited;
        P.gems = j.gems || 500;
        P.crowns = j.crowns || 10;
        P.lv = j.lv || 1;
        P.xp = j.xp || 0;
        P.charId = j.charId || 'glitch';
        P.preset = j.preset || 'hd';
    } catch(e) { console.error("Data load error", e); }
  }

  setText('hGems', P.gems);
  setText('hLv', P.lv);
  const cur = curC();
  const av = $('hAvatar');
  if(av) {
      av.textContent = '';
      av.style.backgroundImage = `url('${getGvEmoji(cur.emoji)}')`;
      av.classList.add('g-emoji');
  }
  document.documentElement.style.fontSize = P.settings.acc ? "18px" : "16px";
  const joyL = $('joyL'), joyR = $('joyR'), btns = $('BTNS');
  if(P.settings.leftHand) {
    if(joyL) { joyL.style.left='auto'; joyL.style.right='18px'; }
    if(joyR) { joyR.style.right='auto'; joyR.style.left='18px'; }
    if(btns) { btns.style.right='auto'; btns.style.left='14px'; }
  } else {
    if(joyL) { joyL.style.right='auto'; joyL.style.left='18px'; }
    if(joyR) { joyL.style.left='auto'; joyR.style.right='18px'; }
    if(btns) { btns.style.left='auto'; btns.style.right='14px'; }
  }

  const sS=$('sShadow'), sL=$('sLeft'), sA=$('sAcc'), sD=$('sDebug'), sAi=$('sAI'), sG=$('sGraph');
  if(sS) sS.checked = P.settings.shadows;
  if(sL) sL.checked = P.settings.leftHand;
  if(sA) sA.checked = P.settings.acc;
  if(sD) sD.checked = P.settings.debug;
  if(sAi) sAi.value = P.settings.ai;
  if(sG) sG.value = P.preset;
}

let selChar='glitch';
let scene,cam,ren,clk,sun;
const BOT_NAMES=['Zippy','Bouncer','Sparky','Glimmer','Turbo','RiftRunner','Echo','Nova','Pixel','Glitchy','Tanker','Frosty','Shadow','Blaze','Bolt','Aura','Rusty','Comet','Pulse','Zen'];
var player,bots=[],lobbyMeshes=[],gameMeshes=[],stars=[],pads=[];
let solidPlatforms=[];
let hillMesh=null;
let interacts=[];
const joy={l:{x:0,y:0},r:{x:0,y:0}};
let camAng=0,pVel={x:0,y:0,z:0},grounded=true,near=null;
let curGame=null,gTimer=0,gActive=false,rGames=[],rIdx=0;
let musicOn=true,padCount=16,scoreT=0;
let particles3d=[];
let shakeAmt=0;

const G=.03,SPD=.13,JMP=.4,FRC=.86;

function getC(id){return CHARS.find(c=>c.id===id)||CHARS[0];}
function curC(){return getC(P.charId);}

function initThree(){
  scene=new THREE.Scene();
  let skyCol = 0x1a2a4a;
  if(P.preset === 'deluxe') skyCol = 0xFFB74D;
  else if(IS_DEC) skyCol = 0x0a1a2a;
  else if(IS_OCT) skyCol = 0x0d0208;
  else if(IS_SPRING) skyCol = 0x81D4FA;
  scene.background=new THREE.Color(skyCol);
  scene.fog=new THREE.FogExp2(skyCol, P.preset === 'deluxe' ? .008 : .005);
  cam=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,.1,800);
  ren=new THREE.WebGLRenderer({canvas:$('C'),antialias:true});
  ren.setSize(innerWidth,innerHeight);
  ren.setPixelRatio(Math.min(devicePixelRatio, 2));
  ren.shadowMap.enabled = P.settings.shadows;
  ren.shadowMap.type = THREE.PCFSoftShadowMap;
  ren.toneMapping = THREE.ACESFilmicToneMapping;
  ren.toneMappingExposure = P.preset === 'deluxe' ? 1.6 : 1.2;
  clk=new THREE.Clock();
  const ambInt = P.preset === 'deluxe' ? 1.0 : 0.5;
  scene.add(new THREE.AmbientLight(0xFFE0B2, ambInt));
  sun=new THREE.DirectionalLight(0xfff5e0, P.preset === 'deluxe' ? 1.8 : 1.1);
  sun.position.set(80,120,80);
  if(P.settings.shadows){
    sun.castShadow=true;
    const s=sun.shadow; s.mapSize.width=s.mapSize.height=2048;
    s.camera.near=20; s.camera.far=400; s.camera.left=s.camera.bottom=-120; s.camera.right=s.camera.top=120;
  }
  scene.add(sun);
  scene.add(new THREE.HemisphereLight(0x6699cc,0x334455,.5));
}

function mat(c,r=.5){
  if(P.preset === 'classic') return new THREE.MeshLambertMaterial({color:c});
  return new THREE.MeshStandardMaterial({color:c, roughness:r, metalness: (P.preset === 'deluxe' ? 0.2 : 0.1)});
}

function makeNameTag(name){
  const canvas = document.createElement('canvas');
  canvas.width = 256; canvas.height = 64;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.roundRect(0, 0, 256, 64, 32);
  ctx.fill();
  ctx.font = 'bold 32px Spline Sans, sans-serif';
  ctx.fillStyle = 'white';
  ctx.textAlign = 'center';
  ctx.fillText(name, 128, 44);
  const tex = new THREE.CanvasTexture(canvas);
  const m = new THREE.SpriteMaterial({map: tex, transparent: true});
  const sprite = new THREE.Sprite(m);
  sprite.scale.set(4, 1, 1);
  sprite.position.y = 2.8;
  return sprite;
}

function makeChar(ch,name='',isBot=false){
  const g=new THREE.Group();
  const col=ch.color;
  const bm=mat(col,.35);
  const body=sMesh(new THREE.CylinderGeometry(.4,.44,.7,12),bm);
  body.position.y=1; g.add(body);
  const top=sMesh(new THREE.SphereGeometry(.4,12,10),bm);
  top.position.y=1.35; g.add(top);
  const bot=sMesh(new THREE.SphereGeometry(.44,12,10),bm);
  bot.position.y=.65; g.add(bot);
  const head=sMesh(new THREE.SphereGeometry(.36,16,14),mat(0xFFDFC4,.45));
  head.position.y=1.85; g.add(head);
  [-1,1].forEach(s=>{
    const eye=sMesh(new THREE.SphereGeometry(.07,8,6),mat(0x111111));
    eye.position.set(s*.12,1.9,.3);g.add(eye);
  });
  if(ch.id==='glitch'){
    [-1,1].forEach(s=>{
      const ear=sMesh(new THREE.SphereGeometry(.12,8,8),mat(0x222222));
      ear.position.set(s*.25,2.15,0); g.add(ear);
      const patch=sMesh(new THREE.SphereGeometry(.1,8,8),mat(0x222222));
      patch.position.set(s*.12,1.9,.28); patch.scale.z=0.1; g.add(patch);
    });
  } else if(ch.id==='tank'){
    [-1,1].forEach(s=>{
      const ear=sMesh(new THREE.ConeGeometry(.15,.3,4),mat(col));
      ear.position.set(s*.22,2.15,0); ear.rotation.z=-s*0.3; g.add(ear);
    });
  } else if(ch.id==='ninja'){
    const mask=sMesh(new THREE.BoxGeometry(.7,.3,.4),mat(0x111111));
    mask.position.set(0,1.85,.2); g.add(mask);
    const band=sMesh(new THREE.BoxGeometry(.8,.1,.45),mat(0x212121));
    band.position.set(0,2,.2); g.add(band);
  } else if(ch.id==='santa'){
    const snout=sMesh(new THREE.CylinderGeometry(.12,.12,.1,12),mat(0xFFA07A));
    snout.position.set(0,1.82,.35); snout.rotation.x=Math.PI/2; g.add(snout);
  }
  const hat=sMesh(new THREE.ConeGeometry(.28,.45,8),mat(0xE74C3C,.4));
  hat.position.y=2.2;hat.rotation.z=.12;g.add(hat);
  if(isBot){
    const ant=sMesh(new THREE.CylinderGeometry(.015,.015,.28,6),mat(0x444444));
    ant.position.y=2.45;g.add(ant);
    const ball=sMesh(new THREE.SphereGeometry(.05,8,6),mat(0xFF4444));
    ball.position.y=2.55;g.add(ball);
  }
  if(name) g.add(makeNameTag(name));
  return g;
}

function addLobbyDeco(){
  for(let i=0; i<12; i++){
    const a=(i/12)*Math.PI*2, r=rnd(15,35);
    const b=sMesh(new THREE.SphereGeometry(.7,12,12), mat(Math.random()*0xffffff, .3));
    b.position.set(Math.cos(a)*r, 10+rnd(0,5), Math.sin(a)*r);
    b.userData={bob:true, baseY:b.position.y}; addMesh(b,true);
    const st=sMesh(new THREE.CylinderGeometry(.02,.02,15), mat(0xcccccc));
    st.position.set(b.position.x, b.position.y-7.5, b.position.z); addMesh(st,true);
  }
}

function buildOctLobby(){
  const gnd=sMesh(new THREE.CircleGeometry(110,60),mat(0x1a0a00));
  gnd.rotation.x=-Math.PI/2;addMesh(gnd,true);
  const plazaR=20,plazaH=1.5;
  const plaza=sMesh(new THREE.CylinderGeometry(plazaR,plazaR,plazaH,32),mat(0x3e2723));
  plaza.position.y=plazaH/2;addMesh(plaza,true);
  solidPlatforms.push({mesh:plaza,radius:plazaR,topY:plazaH});
  const p=new THREE.Group(); p.position.set(0,plazaH,0);
  const pBody=sMesh(new THREE.SphereGeometry(4,16,12),mat(0xff6d00, .2)); pBody.scale.y=0.8; pBody.position.y=3; p.add(pBody);
  const pStem=sMesh(new THREE.CylinderGeometry(0.3,0.5,1.5,8),mat(0x1b5e20)); pStem.position.y=6; p.add(pStem);
  const lt=new THREE.PointLight(0xffab40,3,30); lt.position.y=4; p.add(lt);
  addMesh(p,true);
  buildPortal(0,0,-45); buildMirror(45,0,0); buildArcade(-45,0,0); buildSocial(0,0,45);
  for(let i=0;i<40;i++){
    const a=(i/40)*Math.PI*2, r=45+rnd(0,55);
    const x=Math.cos(a)*r, z=Math.sin(a)*r;
    const jack=sMesh(new THREE.SphereGeometry(rnd(1,2),12,10),mat(0xff6d00)); jack.position.set(x,1,z); addMesh(jack,true);
  }
}

function buildSpringLobby(){
  const gnd=sMesh(new THREE.CircleGeometry(110,60),mat(0x66bb6a));
  gnd.rotation.x=-Math.PI/2;addMesh(gnd,true);
  const plazaR=20,plazaH=1.5;
  const plaza=sMesh(new THREE.CylinderGeometry(plazaR,plazaR,plazaH,32),mat(0xfff176));
  plaza.position.y=plazaH/2;addMesh(plaza,true);
  solidPlatforms.push({mesh:plaza,radius:plazaR,topY:plazaH});
  buildPortal(0,0,-45); buildMirror(45,0,0); buildArcade(-45,0,0); buildSocial(0,0,45);
  for(let i=0;i<60;i++){
    const a=rnd(0,Math.PI*2), r=30+rnd(0,70);
    const flower=sMesh(new THREE.CircleGeometry(0.5,6),mat(rnd(0,1)>0.5?0xff4081:0x00e5ff));
    flower.position.set(Math.cos(a)*r, 0.05, Math.sin(a)*r); flower.rotation.x=-Math.PI/2; addMesh(flower,true);
  }
}

function buildDecLobby(){
  const gnd=sMesh(new THREE.CircleGeometry(110,60),mat(0xE8F4F8,.8));
  gnd.rotation.x=-Math.PI/2;addMesh(gnd,true);
  const plazaR=18,plazaH=3;
  const plaza=sMesh(new THREE.CylinderGeometry(plazaR,plazaR+2,plazaH,32),mat(0x6D4C41,.5));
  plaza.position.y=plazaH/2;addMesh(plaza,true);
  solidPlatforms.push({mesh:plaza,radius:plazaR+2,topY:plazaH});
  buildXmasTree(0,plazaH,0);
  buildPortal(0,0,-42); buildMirror(42,0,0); buildArcade(-42,0,0); buildSocial(0,0,42);
  for(let i=0;i<30;i++){ const a=(i/30)*Math.PI*2+rnd(-.2,.2),r=55+rnd(0,45); buildPine(Math.cos(a)*r,Math.sin(a)*r); }
  for(let i=0;i<8;i++){ const a=rnd(0,Math.PI*2),r=30+rnd(0,35); buildSnowman(Math.cos(a)*r,Math.sin(a)*r); }
  for(let i=0;i<15;i++){ const a=rnd(0,Math.PI*2),r=24+rnd(0,50); buildPresent(Math.cos(a)*r,Math.sin(a)*r); }
  for(let i=0;i<6;i++){ const a=(i/6)*Math.PI*2,r=30; buildLamp(Math.cos(a)*r,Math.sin(a)*r); }
}

function buildDefaultLobby(){
  const gnd=sMesh(new THREE.CircleGeometry(110,60),mat(0x388E3C));
  gnd.rotation.x=-Math.PI/2;addMesh(gnd,true);
  const plazaR=20,plazaH=1.5;
  const plaza=sMesh(new THREE.CylinderGeometry(plazaR,plazaR,plazaH,32),mat(0xCFD8DC));
  plaza.position.y=plazaH/2;addMesh(plaza,true);
  solidPlatforms.push({mesh:plaza,radius:plazaR,topY:plazaH});
  const f=new THREE.Group(); f.position.set(0,plazaH,0);
  const fBase=sMesh(new THREE.CylinderGeometry(5,5,0.8,24),mat(0x90A4AE)); fBase.position.y=0.4; f.add(fBase);
  const fMid=sMesh(new THREE.CylinderGeometry(1,1,3,16),mat(0x90A4AE)); fMid.position.y=2; f.add(fMid);
  const fTop=sMesh(new THREE.CylinderGeometry(3,3,0.4,16),mat(0x90A4AE)); fTop.position.y=3.5; f.add(fTop);
  const water=sMesh(new THREE.SphereGeometry(2.5,16,12,0,Math.PI*2,0,Math.PI/2),mat(0x29B6F6,.6));
  water.position.y=3.5; f.add(water);
  const lt=new THREE.PointLight(0x29B6F6,2,25); lt.position.y=5; f.add(lt);
  addMesh(f,true);
  addLobbyDeco();
  buildPortal(0,0,-45); buildMirror(45,0,0); buildArcade(-45,0,0); buildSocial(0,0,45);
  for(let i=0;i<40;i++){
    const a=(i/40)*Math.PI*2+rnd(-.1,.1), r=45+rnd(0,55);
    const x=Math.cos(a)*r, z=Math.sin(a)*r;
    if(Math.random()>0.4){
      const h=rnd(6,15);
      const tree=new THREE.Group(); tree.position.set(x,0,z);
      const tr=sMesh(new THREE.CylinderGeometry(.4,.6,h*.3,8),mat(0x5D4037)); tr.position.y=h*.15; tree.add(tr);
      const leaf=sMesh(new THREE.ConeGeometry(rnd(3,5),h*.8,8),mat(0x2E7D32)); leaf.position.y=h*.5; tree.add(leaf);
      addMesh(tree,true);
    } else {
      const rock=sMesh(new THREE.DodecahedronGeometry(rnd(2,4)),mat(0x9E9E9E));
      rock.position.set(x,1,z); rock.rotation.set(rnd(0,6),rnd(0,6),rnd(0,6)); addMesh(rock,true);
    }
  }
}

function buildLobby(){
  lobbyMeshes.forEach(o=>scene.remove(o)); lobbyMeshes=[];
  gameMeshes.forEach(o=>scene.remove(o)); gameMeshes=[];
  interacts=[];
  stars=[];pads=[];
  solidPlatforms=[];
  if(IS_DEC) buildDecLobby();
  else if(IS_OCT) buildOctLobby();
  else if(IS_SPRING) buildSpringLobby();
  else buildDefaultLobby();
}

function buildXmasTree(x,y,z){
  const g=new THREE.Group();g.position.set(x,y,z);
  const trunk=sMesh(new THREE.CylinderGeometry(1,1.5,3,10),mat(0x5D4037,.8));
  trunk.position.y=1.5; g.add(trunk);
  for(let i=0;i<4;i++){
    const layer=sMesh(new THREE.ConeGeometry(5.5-i*1,4.5,12),mat(0x2E7D32,.7));
    layer.position.y=4.5+i*3; g.add(layer);
  }
  const star=sMesh(new THREE.OctahedronGeometry(1),mat(0xFFD700,.2));
  star.position.y=18;star.userData.spin=true;g.add(star);
  for(let i=0;i<35;i++){
    const orb=sMesh(new THREE.SphereGeometry(.3,10,8),mat([0xFF0000,0x0000FF,0xFFD700,0xFF69B4][i%4],.3));
    const a=rnd(0,Math.PI*2),r=rnd(.8,4.5-i/10),h=4.5+rnd(0,10);
    orb.position.set(Math.cos(a)*r,h,Math.sin(a)*r);g.add(orb);
  }
  scene.add(g);lobbyMeshes.push(g);
}

function buildSocial(x,y,z){
  const g=new THREE.Group(); g.position.set(x,0,z);
  const base=sMesh(new THREE.CylinderGeometry(4,4.5,1,24),mat(0x27ae60)); g.add(base);
  const ring=sMesh(new THREE.TorusGeometry(3.5,0.3,12,32),mat(0x2ecc71)); ring.rotation.x=Math.PI/2; ring.position.y=0.5; g.add(ring);
  const ico=sMesh(new THREE.IcosahedronGeometry(1.5,0),mat(0xffffff,.2)); ico.position.y=4.5; ico.userData.spin=true; ico.userData.bob=true; ico.userData.baseY=4.5; g.add(ico);
  const lt=new THREE.PointLight(0x2ecc71,2,15); lt.position.y=4; g.add(lt);
  g.userData={type:'social', icon:'üë•', text:'Friends'};
  addMesh(g,true); interacts.push(g);
}

function buildPortal(x,y,z){
  const g=new THREE.Group();g.position.set(x,y,z);
  for(let i=0;i<3;i++){
    const step=sMesh(new THREE.CylinderGeometry(8-i,8.5-i,.6,14),mat(0xE0E0E0,.3));
    step.position.y=.3+i*.6; g.add(step);
  }
  const ring=sMesh(new THREE.TorusGeometry(3,.6,10,20),mat(0x9C27B0,.3));
  ring.position.y=5;ring.userData.spin=true;g.add(ring);
  const orb=sMesh(new THREE.SphereGeometry(1.6,14,12),mat(0x00E5FF,.2));
  orb.position.y=5;orb.userData.bob=true;orb.userData.baseY=5;g.add(orb);
  g.userData={interact:true,type:'portal',text:'Enter Portal',icon:'üåÄ',r:12};
  scene.add(g);lobbyMeshes.push(g);interacts.push(g);
}

function buildMirror(x,y,z){
  const g=new THREE.Group();g.position.set(x,y,z);
  const frame=sMesh(new THREE.BoxGeometry(5,7,.7),mat(0xFFD700,.2));
  frame.position.y=4; g.add(frame);
  const mirror=sMesh(new THREE.BoxGeometry(4.2,6,.15),new THREE.MeshStandardMaterial({color:0xE8EAF6,metalness:.95,roughness:.05}));
  mirror.position.set(0,4,.45);g.add(mirror);
  g.rotation.y=-Math.PI/2;
  g.userData={interact:true,type:'char',text:'Choose Runner',icon:'üé≠',r:10};
  scene.add(g);lobbyMeshes.push(g);interacts.push(g);
}

function buildArcade(x,y,z){
  const g=new THREE.Group();g.position.set(x,y,z);
  const body=sMesh(new THREE.BoxGeometry(5,6.5,3),mat(0x1A237E,.5));
  body.position.y=3.25; g.add(body);
  const screen=sMesh(new THREE.BoxGeometry(3.5,2.5,.15),mat(0x00E676,.3));
  screen.position.set(0,4.5,1.6);g.add(screen);
  g.rotation.y=Math.PI/2;
  g.userData={interact:true,type:'arcade',text:'Practice',icon:'üïπÔ∏è',r:10};
  scene.add(g);lobbyMeshes.push(g);interacts.push(g);
}

function buildPine(x,z){
  const h=rnd(8,16); const g=new THREE.Group(); g.position.set(x,0,z);
  const tr=sMesh(new THREE.CylinderGeometry(.4,.8,h*.2,8),mat(0x5D4037)); tr.position.y=h*.1; g.add(tr);
  for(let i=0;i<3;i++){
    const l=sMesh(new THREE.ConeGeometry(5-i,h*.4,10),mat(0x2E7D32));
    l.position.y=h*.3+i*h*.25; g.add(l);
  }
  addMesh(g,true);
}

function buildSnowman(x,z){
  const g=new THREE.Group(); g.position.set(x,0,z);
  [1,.65,.4].forEach((s,i)=>{
    const b=sMesh(new THREE.SphereGeometry(s,12,10),mat(0xffffff)); b.position.y=s+(i==1?1.5:i==2?2.3:0); g.add(b);
  });
  addMesh(g,true);
}

function buildPresent(x,z){
  const s=rnd(.8,1.5); const b=sMesh(new THREE.BoxGeometry(s,s,s),mat(Math.random()*0xffffff));
  b.position.set(x,s/2,z); b.rotation.y=rnd(0,6); addMesh(b,true);
}

function buildLamp(x,z){
  const g=new THREE.Group(); g.position.set(x,0,z);
  const p=sMesh(new THREE.CylinderGeometry(.1,.1,6),mat(0x333333)); p.position.y=3; g.add(p);
  const l=sMesh(new THREE.SphereGeometry(.6,10,8),mat(0xfff5e0,.2)); l.position.y=6; g.add(l);
  const lt=new THREE.PointLight(0xfff5e0,1.5,15); lt.position.y=6; g.add(lt);
  addMesh(g,true);
}

function spawnPlayer(){
  if(player) scene.remove(player);
  const ch = curC();
  player = makeChar(ch, 'YOU');
  player.position.set(0,3.5,22);
  scene.add(player);
  if(ch.id === 'ninja') {
    player.traverse(o => { if(o.isMesh) { o.material = o.material.clone(); o.material.transparent = true; o.material.opacity = 0.5; } });
  }
}

function spawnBots(n){
  bots.forEach(b=>scene.remove(b.mesh)); bots=[];
  const pool=CHARS.filter(c=>c.id!==P.charId);
  const names = [...P.invited];
  while(names.length < n){
    const rn = BOT_NAMES[Math.floor(Math.random()*BOT_NAMES.length)];
    if(!names.includes(rn)) names.push(rn);
  }
  const botChars = [];
  for(let i=0; i<n; i++) botChars.push(pool[Math.floor(Math.random()*pool.length)]);
  for(let i=0; i<n; i++){
    const ch=botChars[i], name=names[i];
    const mesh=makeChar(ch,name,true);
    const a=((i+1)/(n+1))*Math.PI*2,r=24+rnd(0,10);
    mesh.position.set(Math.cos(a)*r,0,Math.sin(a)*r);
    bots.push({
      mesh, ch, name, emoji:ch.emoji, color:ch.color,
      score:0, isIt:false, tagImmune:0, stunned:0,
      vel:{x:0,y:0,z:0}, grounded:true, eliminated:false,
      hillTime:0, target:null, aiTimer:0, skillCD:0,
      mem: { bad: [] }
    });
    scene.add(mesh);
  }
}

function getGroundY(pos){
  let gy=0;
  if(true){
    solidPlatforms.forEach(sp=>{
      const d=d2(pos,sp.mesh.position);
      if(d<sp.radius) gy=Math.max(gy,sp.topY);
    });
  }
  if(hillMesh){
    const hd=d2(pos,hillMesh.mesh.position);
    if(hd<hillMesh.radius) gy=Math.max(gy,hillMesh.topY);
  }
  return gy;
}

function applyPhysics(pos,vel){
  if(!grounded) vel.y-=G;
  pos.x+=vel.x; pos.y+=vel.y; pos.z+=vel.z;
  const gy=getGroundY(pos);
  if(pos.y<=gy){ pos.y=gy; vel.y=0; grounded=true; } else grounded=false;
  vel.x*=FRC; vel.z*=FRC;
}

function applyBotPhysics(b){
  if(!b.grounded) b.vel.y-=G;
  b.mesh.position.x+=b.vel.x; b.mesh.position.y+=b.vel.y; b.mesh.position.z+=b.vel.z;
  const gy=getGroundY(b.mesh.position);
  if(b.mesh.position.y<=gy){ b.mesh.position.y=gy; b.vel.y=0; b.grounded=true; } else b.grounded=false;
  b.vel.x*=FRC; b.vel.z*=FRC;
}

function initControls(){
  mkJoy('joyL','knobL','l'); mkJoy('joyR','knobR','r');
  const tap=(id,fn)=>{const e=$(id);if(!e)return;e.addEventListener('touchstart',ev=>{ev.preventDefault();ev.stopPropagation();fn();},{passive:false});e.addEventListener('click',ev=>{ev.preventDefault();fn();});};
  tap('prGo',doInteract); tap('bJump',doJump); tap('bGrab',doGrab); tap('bSkill',doSkill);

  const emPop = $('emPop'); const emGrid = $('emoteGrid');
  if(emGrid) {
      EMOTES.forEach(e => {
          const b = document.createElement('button');
          b.className = 'size-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center g-emoji transition-all active:scale-90';
          b.style.backgroundImage = `url('${getGvEmoji(e)}')`;
          b.onclick = () => { showEmoji(player, e); emPop.classList.add('hidden'); };
          emGrid.appendChild(b);
      });
  }
  tap('bEmote', () => emPop.classList.toggle('hidden'));

  const sp=$('bSprint');
  if(sp){
    sp.addEventListener('touchstart',ev=>{ev.preventDefault();P.sprinting=true;sp.classList.add('on');},{passive:false});
    sp.addEventListener('touchend',()=>{P.sprinting=false;sp.classList.remove('on');});
    sp.addEventListener('mousedown',()=>{P.sprinting=true;sp.classList.add('on');});
    sp.addEventListener('mouseup',()=>{P.sprinting=false;sp.classList.remove('on');});
  }
}


function mkJoy(areaId,knobId,key){
  const a=$(areaId); if(!a)return;
  const knob=$(knobId);
  let tid=null, cx=0, cy=0;
  const upd=(x,y)=>{
    let dx=x-cx, dy=y-cy, d=Math.sqrt(dx*dx+dy*dy);
    const r=50; if(d>r){dx*=r/d;dy*=r/d;d=r;}
    knob.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    joy[key]={x:dx/r, y:dy/r};
  };
  a.addEventListener('touchstart',ev=>{ev.preventDefault();const t=ev.changedTouches[0];tid=t.identifier;const r=a.getBoundingClientRect();cx=r.left+r.width/2;cy=r.top+r.height/2;upd(t.clientX,t.clientY);},{passive:false});
  a.addEventListener('touchmove',ev=>{ev.preventDefault();for(let t of ev.changedTouches)if(t.identifier===tid)upd(t.clientX,t.clientY);},{passive:false});
  a.addEventListener('touchend',ev=>{for(let t of ev.changedTouches)if(t.identifier===tid){tid=null;knob.style.transform='translate(-50%,-50%)';joy[key]={x:0,y:0};}},{passive:false});
  a.addEventListener('mousedown',ev=>{const r=a.getBoundingClientRect();cx=r.left+r.width/2;cy=r.top+r.height/2;upd(ev.clientX,ev.clientY);const mv=e=>upd(e.clientX,e.clientY),up=()=>{document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);knob.style.transform='translate(-50%,-50%)';joy[key]={x:0,y:0};};document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);});
}

function doInteract(){
  if(!near)return;
  const t=near.userData.type;
  if(t==='portal'){show('oPortal');loadModes();}
  else if(t==='char'){show('oChar');loadChars();}
  else if(t==='arcade'){show('oArcade');loadArcade();}
  else if(t==='social'){show('oSocial');loadSocial();}
  $('PROMPT')?.classList.remove('show');
}

function loadSocial(){
  const el=$('socialList'); if(!el)return;
  el.innerHTML='';
  if(P.friends.length === 0) {
    el.innerHTML = '<div class="py-12 text-center text-gray-500 font-medium">No friends yet.<br>Add bots after a game!</div>';
    return;
  }
  P.friends.forEach(name => {
    const isInv = P.invited.includes(name);
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between p-4 bg-card-dark rounded-2xl border border-white/5 mb-3';
    row.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-full bg-white/5 flex items-center justify-center g-emoji" style="background-image:url('${getGvEmoji('ü§ñ')}')"></div>
        <span class="font-bold">${name}</span>
      </div>
      <button class="px-4 py-2 rounded-full text-xs font-bold transition-all ${isInv?'bg-primary text-black':'bg-white/10 text-white'}" onclick="toggleInvite('${name}', this)">
        ${isInv?'Invited ‚úÖ':'Invite'}
      </button>
    `;
    el.appendChild(row);
  });
}

function toggleInvite(name, btn){
  const idx = P.invited.indexOf(name);
  if(idx > -1) { P.invited.splice(idx, 1); btn.textContent = 'Invite'; btn.classList.remove('bg-primary', 'text-black'); btn.classList.add('bg-white/10', 'text-white'); }
  else { if(P.invited.length >= 8) { notify('Max 8 invited bots!','bad'); return; } P.invited.push(name); btn.textContent = 'Invited ‚úÖ'; btn.classList.add('bg-primary', 'text-black'); btn.classList.remove('bg-white/10', 'text-white'); }
  saveData();
}

function loadModes(){
  const el=$('modeList'); if(!el)return;
  el.innerHTML='<div class="space-y-4 pt-4"></div>';
  const ml=el.firstChild;
  [{name:'‚ö° Quick Play',desc:'One random rift',cnt:1,icon:'‚ö°'},{name:'üéâ Party Mode',desc:'Three random rifts',cnt:3,icon:'üéâ'}].forEach(m=>{
    const c=document.createElement('div');
    c.className='group p-5 bg-card-dark rounded-3xl border-2 border-transparent hover:border-primary/40 transition-all cursor-pointer flex items-center gap-4';
    c.innerHTML=`
      <div class="size-14 rounded-2xl bg-white/5 flex items-center justify-center text-3xl g-emoji" style="background-image:url('${getGvEmoji(m.icon)}')"></div>
      <div class="flex-1">
        <h4 class="font-black text-lg leading-none mb-1 group-hover:text-primary transition-colors">${m.name}</h4>
        <p class="text-xs text-gray-500 font-medium">${m.desc}</p>
      </div>
      <span class="material-symbols-outlined text-gray-600 group-hover:text-primary">arrow_forward_ios</span>
    `;
    c.onclick=()=>{hide('oPortal');rGames=shuffle(GAMES).slice(0,m.cnt);rIdx=0;setTimeout(()=>startMinigame(rGames[0]),300);};
    ml.appendChild(c);
  });
}

function loadChars(){
  const el=$('charList'); if(!el)return;
  el.innerHTML='';
  CHARS.forEach(c => {
    const isSel = c.id === selChar;
    const item = document.createElement('div');
    item.className = 'group relative flex flex-col items-center gap-2';
    item.innerHTML = `
      ${isSel ? '<div class="absolute -top-2 -right-2 z-10 bg-primary text-black rounded-full p-1 shadow-lg shadow-primary/20"><span class="material-symbols-outlined text-sm font-bold block">check</span></div>' : ''}
      <button class="w-full aspect-square bg-card-dark rounded-xl border-2 ${isSel?'border-primary shadow-[0_0_15px_rgba(242,242,13,0.1)]':'border-transparent hover:border-white/10'} transition-all flex items-center justify-center relative overflow-hidden">
        ${isSel ? '<div class="absolute inset-0 bg-primary/5"></div>' : ''}
        <div class="w-full h-full bg-center bg-contain bg-no-repeat transform scale-75 g-emoji" style="background-image: url('${getGvEmoji(c.emoji)}');"></div>
      </button>
      <span class="text-xs font-bold ${isSel?'text-primary':'text-gray-500 group-hover:text-white'} transition-colors">${c.name}</span>
    `;
    item.onclick = () => { selChar = c.id; loadChars(); };
    el.appendChild(item);
  });
  updateCharDetail(getC(selChar));
}

function updateCharDetail(c){
  const el=$('charDetail'); if(!el)return;
  el.innerHTML = `
    <h2 class="text-white text-[2.5rem] font-black italic tracking-tighter leading-none mb-1">${c.name.toUpperCase()}</h2>
    <p class="text-primary text-sm font-black tracking-widest uppercase mb-8">${c.role}</p>
    <div class="grid grid-cols-3 w-full gap-4 mb-8">
        <div class="flex flex-col items-center gap-2 p-4 rounded-2xl bg-card-dark border ${c.pow>70?'border-primary/30':'border-white/5'} relative overflow-hidden group">
            <div class="size-10 rounded-full ${c.pow>70?'bg-primary text-black':'bg-white/10 text-gray-400'} flex items-center justify-center mb-1">
                <span class="material-symbols-outlined filled text-xl">fitness_center</span>
            </div>
            <div class="text-center">
                <p class="text-[10px] font-bold ${c.pow>70?'text-primary':'text-gray-500'} uppercase">Power</p>
                <div class="h-1 w-12 bg-gray-800 rounded-full mt-1 overflow-hidden">
                    <div class="h-full bg-current rounded-full" style="width:${c.pow}%; color: ${c.pow>70?'#f2f20d':'#666'}"></div>
                </div>
            </div>
        </div>
        <div class="flex flex-col items-center gap-2 p-4 rounded-2xl bg-card-dark border ${c.spd>70?'border-primary/30':'border-white/5'} relative overflow-hidden">
            <div class="size-10 rounded-full ${c.spd>70?'bg-primary text-black':'bg-white/10 text-gray-400'} flex items-center justify-center mb-1">
                <span class="material-symbols-outlined filled text-xl">bolt</span>
            </div>
            <div class="text-center">
                <p class="text-[10px] font-bold ${c.spd>70?'text-primary':'text-gray-500'} uppercase">Speed</p>
                <div class="h-1 w-12 bg-gray-800 rounded-full mt-1 overflow-hidden">
                    <div class="h-full bg-current rounded-full" style="width:${c.spd}%; color: ${c.spd>70?'#f2f20d':'#666'}"></div>
                </div>
            </div>
        </div>
        <div class="flex flex-col items-center gap-2 p-4 rounded-2xl bg-card-dark border ${c.jmp>70?'border-primary/30':'border-white/5'} relative overflow-hidden">
            <div class="size-10 rounded-full ${c.jmp>70?'bg-primary text-black':'bg-white/10 text-gray-400'} flex items-center justify-center mb-1">
                <span class="material-symbols-outlined filled text-xl">stat_2</span>
            </div>
            <div class="text-center">
                <p class="text-[10px] font-bold ${c.jmp>70?'text-primary':'text-gray-500'} uppercase">Jump</p>
                <div class="h-1 w-12 bg-gray-800 rounded-full mt-1 overflow-hidden">
                    <div class="h-full bg-current rounded-full" style="width:${c.jmp}%; color: ${c.jmp>70?'#f2f20d':'#666'}"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="w-full bg-card-dark border border-white/5 rounded-2xl p-4 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
            <div class="size-10 rounded-full bg-primary/10 text-primary flex items-center justify-center shrink-0 border border-primary/20 g-emoji" style="background-image:url('${getGvEmoji(c.emoji)}')"></div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Special Skill</span>
                <span class="text-white font-black text-lg">${c.skill}</span>
            </div>
        </div>
    </div>
  `;
  $('btnPlayAs').onclick = () => {
    if(P.charId !== selChar) { P.charId = selChar; saveData(); spawnPlayer(); loadData(); }
    hide('oChar');
  };
}

function loadArcade(){
  const el=$('modeList'); if(!el)return;
  el.innerHTML='<div class="grid grid-cols-2 gap-3 pt-4"></div>';
  const ml=el.firstChild;
  GAMES.forEach(g=>{
    const c=document.createElement('div');
    c.className='p-4 bg-card-dark rounded-2xl border border-white/5 hover:border-primary/30 transition-all cursor-pointer text-center';
    c.innerHTML=`<div class="text-3xl mb-2 g-emoji size-12 mx-auto" style="background-image:url('${getGvEmoji(g.name.split(' ')[0])}')"></div><div class="font-bold text-xs">${g.name}</div>`;
    c.onclick=()=>{hide('oArcade');curGame=g;setTimeout(()=>startMinigame(g),300);};
    ml.appendChild(c);
  });
}

function doJump(){
  if(P.stunned>0||!grounded)return;
  pVel.y=JMP*(curC().jmp/80); grounded=false;
  mkParts(player.position.x,.3,player.position.z,0xFFFFFF,12);
}

function doPush(){
  if(P.grabCD>0)return;
  P.grabCD=0.8;
  const targets = bots.filter(b=>!b.eliminated);
  let pushed=false;
  targets.forEach(b=>{
    const d = d3(player.position, b.mesh.position);
    if(d < 4.5){
      const dx = b.mesh.position.x - player.position.x, dz = b.mesh.position.z - player.position.z, mag = Math.sqrt(dx*dx+dz*dz) || 1;
      b.vel.x += (dx/mag)*0.6; b.vel.z += (dz/mag)*0.6; b.vel.y = 0.25; b.stunned = 1.2; pushed=true;
    }
  });
  if(pushed) { flash('bGrab', 200); mkParts(player.position.x, 1.5, player.position.z, 0xffffff, 10); }
}
function doGrab(){ doPush(); }

function doSkill(){
  if(P.skillCD>0||P.stunned>0)return;
  if(state!==ST.GAME&&state!==ST.LOBBY)return;
  const c=curC(); P.skillCD=c.sCD; cooldown('bSkill','cdSkill',c.sCD,'skillCD');
  const fwd=new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0),player.rotation.y);
  switch(c.sType){
    case 'tele': mkParts(player.position.x,1.5,player.position.z,0x00FFFF,20); player.position.add(fwd.multiplyScalar(10)); mkParts(player.position.x,1.5,player.position.z,0x00FFFF,30); break;
    case 'dash': pVel.x+=fwd.x*1.2; pVel.z+=fwd.z*1.2; flash('SPEED',500); mkParts(player.position.x,1,player.position.z,0x4ECDC4,25); break;
    case 'jump': pVel.y=.7; grounded=false; mkParts(player.position.x,.3,player.position.z,0xFF69B4,25); break;
    case 'stun':
      bots.forEach(b=>{if(d3(player.position,b.mesh.position)<12){b.stunned=2.5;b.vel.y=.2;mkParts(b.mesh.position.x,1.5,b.mesh.position.z,0xFFD700,20);showEmoji(b.mesh,'üí´');}});
      shakeAmt=.8;
      break;
    case 'smoke':
      mkParts(player.position.x,1.5,player.position.z,0x333333,50);
      bots.forEach(b=>{if(d3(player.position,b.mesh.position)<10){b.stunned=2;showEmoji(b.mesh,'‚ùì');}});
      player.visible = false; setTimeout(()=>player.visible=true, 3000);
      break;
    case 'buff': P.buffTime=5; notify('POWER UP!','ok'); flash('SPEED',5000); mkParts(player.position.x,2,player.position.z,0xFF0000,30); break;
  }
  notify(c.skill+'!','inf'); showEmoji(player, c.emoji);
}

function cooldown(btnId,cdId,dur,prop){
  const btn=$(btnId); if(btn)btn.classList.add('cd');
  let rem=dur;
  const iv=setInterval(()=>{ rem-=.1; const cd=$(cdId); if(cd)cd.textContent=Math.max(0,Math.ceil(rem)); if(rem<=0){clearInterval(iv);P[prop]=0;if(btn)btn.classList.remove('cd');} },100);
}

function startMinigame(game){
  state=ST.CDOWN; curGame=game; scoreT=0; musicOn=true; padCount=16; hillMesh=null;
  $('hud').style.display='none'; $('MM')?.classList.remove('show'); $('PROMPT')?.classList.remove('show'); $('SIDE').style.display='flex';
  const gb=$('bGrab'); if(gb)gb.classList.toggle('hidden',game.type==='collect'||game.type==='pads');
  lobbyMeshes.forEach(o=>o.visible=false); player.visible=false; bots.forEach(b=>b.mesh.visible=false);
  solidPlatforms=[]; buildArena(game);
  setText('cdName',game.name); setText('cdTip',game.tip); show('CDOWN');
  let cnt=3; setText('cdNum','3'); $('cdNum').className='cd-num';
  const iv=setInterval(()=>{ cnt--; if(cnt>0)setText(cnt); else if(cnt===0){setText('cdNum','GO!');$('cdNum').className='cd-num cd-go';} else {clearInterval(iv);hide('CDOWN');beginGame();} },900);
}

function beginGame(){
  state=ST.GAME; gActive=true; gTimer=curGame.dur;
  show('GHUD'); setText('gTitle',curGame.name); show('SB'); $('BTNS').style.display='flex';
  P.score=0; P.isIt=false; P.tagImmune=0; P.stamina=100; P.hillTime=0; P.sprinting=false;
  bots.forEach(b=>{b.score=0;b.isIt=false;b.tagImmune=0;b.eliminated=false;b.mesh.visible=true;b.stunned=0;b.hillTime=0;b.aiTimer=0;b.skillCD=rnd(3,6);});
  if(curGame.type==='tag'){ const it=bots[Math.floor(Math.random()*bots.length)]; it.isIt=true; it.tagImmune=4; updInd(); }
  if(curGame.type==='pads'){ resetPads(); updInd(); }
  const tEl=$('gTime');
  const iv=setInterval(()=>{
    if(!gActive){clearInterval(iv);return;}
    gTimer--;
    if(tEl){tEl.textContent=Math.max(0,gTimer);tEl.className='g-time';if(gTimer<=10)tEl.classList.add('danger');else if(gTimer<=20)tEl.classList.add('warn');}
    if(curGame?.type==='pads'&&gTimer%11===0&&gTimer>0&&gTimer<curGame.dur){
      musicOn=!musicOn;
      if(!musicOn){padCount=Math.max(2,padCount-2);notify('üéµ MUSIC STOPPED!','inf');setTimeout(()=>checkPads(),1200);}
      else{notify('üéµ Playing!','inf');resetPads();}
      updInd();
    }
    if(gTimer<=0){clearInterval(iv);endMinigame();}
  },1000);
}

function buildArena(game){
  lobbyMeshes.forEach(o=>scene.remove(o)); lobbyMeshes=[]; gameMeshes.forEach(o=>scene.remove(o)); gameMeshes=[];
  stars=[]; pads=[]; hillMesh=null; solidPlatforms=[];
  const bgMap={collect:0x0D47A1,sumo:0x3E2723,hill:0xBF360C,tag:0x01579B,pads:0x4A148C};
  scene.background=new THREE.Color(bgMap[game.type]||0x1a2a4a);
  scene.fog=new THREE.FogExp2(bgMap[game.type]||0x1a2a4a,.004);
  const R=game.type==='sumo'?50:85;
  const gnd=sMesh(new THREE.CircleGeometry(R,60),mat({collect:0x2E7D32,sumo:0x5D4037,hill:0xBF360C,tag:0x006064,pads:0x4A148C}[game.type]||0x2E7D32,.8));
  gnd.rotation.x=-Math.PI/2; addMesh(gnd,false);
  const bor=sMesh(new THREE.TorusGeometry(R,1.5,10,60),mat(0xFFD700,.4));
  bor.rotation.x=Math.PI/2; bor.position.y=.75; addMesh(bor,false);
  if(game.type==='collect'){
    for(let i=0;i<55;i++)spawnStar();
    for(let i=0;i<5;i++){ const a=(i/5)*Math.PI*2, r=40, x=Math.cos(a)*r, z=Math.sin(a)*r; const p=sMesh(new THREE.CylinderGeometry(8,8,4,16),mat(0x1B5E20)); p.position.set(x,2,z); addMesh(p,false); solidPlatforms.push({mesh:p,radius:8,topY:4}); }
  }
  if(game.type==='hill'){
    const hm=sMesh(new THREE.CylinderGeometry(16,20,10,32),mat(0xFFD700,.35)); hm.position.y=4; scene.add(hm); gameMeshes.push(hm); hillMesh={mesh:hm,radius:15.5,topY:9};
    const crown=sMesh(new THREE.ConeGeometry(3,4,5),mat(0xFFD700,.2)); crown.position.y=11; crown.userData.spin=true; crown.userData.bob=true; crown.userData.baseY=11; scene.add(crown); gameMeshes.push(crown);
    for(let i=0;i<4;i++){ const a=(i/4)*Math.PI*2, r=40, x=Math.cos(a)*r, z=Math.sin(a)*r; const p=sMesh(new THREE.CylinderGeometry(8,8,4,16),mat(0xBF360C)); p.position.set(x,2,z); addMesh(p); solidPlatforms.push({mesh:p,radius:8,topY:4}); }
  }
  if(game.type==='pads'){
    const sz=4,sp=12,off=-(sz-1)*sp/2;
    for(let x=0;x<sz;x++)for(let z=0;z<sz;z++){
      const pad=sMesh(new THREE.CylinderGeometry(6,6.5,1.5,16),mat(0x9C27B0,.35)); pad.position.set(off+x*sp,.6,off+z*sp); pad.userData={active:true,idx:x*sz+z}; scene.add(pad); gameMeshes.push(pad); pads.push(pad); solidPlatforms.push({mesh:pad,radius:6,topY:1.35});
    }
  }
  if(game.type==='tag'){
    for(let i=0;i<8;i++){ const a=(i/8)*Math.PI*2, r=30, x=Math.cos(a)*r, z=Math.sin(a)*r; const p=sMesh(new THREE.BoxGeometry(6,12,6),mat(0x006064)); p.position.set(x,6,z); addMesh(p); solidPlatforms.push({mesh:p,radius:4,topY:12}); }
  }
  if(game.type==='sumo'){
    for(let i=0;i<6;i++){ const a=(i/6)*Math.PI*2+rnd(-.3,.3),r=12+rnd(0,10); const p=sMesh(new THREE.DodecahedronGeometry(rnd(3,5)),mat(0x5D4037)); p.position.set(Math.cos(a)*r,2,Math.sin(a)*r); p.rotation.set(rnd(0,6),rnd(0,6),rnd(0,6)); addMesh(p); solidPlatforms.push({mesh:p,radius:4,topY:4}); }
  }
  player.visible=true; player.position.set(0,10,28); pVel={x:0,y:0,z:0}; grounded=false;
  bots.forEach((b,i)=>{ b.mesh.visible=true; b.eliminated=false; const a=((i+1)/(bots.length+1))*Math.PI*2,r=22+rnd(0,10); b.mesh.position.set(Math.cos(a)*r,10,Math.sin(a)*r); b.vel={x:0,y:0,z:0}; b.stunned=0; b.grounded=false; });
}

function spawnStar(){
  const gold=Math.random()<.12; const val=gold?30:10;
  const shape=new THREE.Shape(); for(let i=0;i<10;i++){const r=i%2===0?.8:.38,a=(i/10)*Math.PI*2-Math.PI/2;if(i===0)shape.moveTo(Math.cos(a)*r,Math.sin(a)*r);else shape.lineTo(Math.cos(a)*r,Math.sin(a)*r);} shape.closePath();
  const m=gold ? new THREE.MeshStandardMaterial({color:0xFFD700, metalness:0.8, roughness:0.2}) : mat(0xFFFFFF, 0.3);
  const mesh=sMesh(new THREE.ExtrudeGeometry(shape,{depth:.35,bevelEnabled:false}),m); if(gold)mesh.scale.setScalar(1.5);
  const a=rnd(0,Math.PI*2),r=rnd(10,60); mesh.position.set(Math.cos(a)*r,2.5,Math.sin(a)*r); mesh.rotation.x=Math.PI/2; mesh.userData={val,off:rnd(0,Math.PI*2)};
  scene.add(mesh); gameMeshes.push(mesh); stars.push(mesh);
}

function runBotAI(dt){
  const spd_base=SPD*.78*(curGame?.type==='pads'?.6:1)*(curGame?.type==='sumo'?.7:1)*(P.settings.ai==='hard'?1.2:P.settings.ai==='easy'?0.7:1);
  bots.forEach((b,idx)=>{
    if(b.eliminated){b.mesh.visible=true;return;}
    if(b.stunned>0){b.stunned-=dt;return;}
    if(b.tagImmune>0)b.tagImmune-=dt;

    // Bot Skills
    if(!b.skillCD) b.skillCD = rnd(5, 10);
    b.skillCD -= dt;
    if(b.skillCD <= 0 && !b.stunned && state === ST.GAME) {
      const distToPlayer = d3(b.mesh.position, player.position);
      let trigger = false;
      if(['stun', 'smoke'].includes(b.ch.sType) && distToPlayer < 8) trigger = true;
      else if(['dash', 'tele', 'jump'].includes(b.ch.sType) && b.target && d3(b.mesh.position, b.target) > 15) trigger = true;
      else if(b.ch.sType === 'buff' && Math.random() < 0.3) trigger = true;
      if(trigger) {
        b.skillCD = b.ch.sCD + rnd(2, 5);
        const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), b.mesh.rotation.y);
        switch(b.ch.sType) {
          case 'tele': b.mesh.position.add(fwd.multiplyScalar(8)); break;
          case 'dash': b.vel.x += fwd.x * 0.8; b.vel.z += fwd.z * 0.8; break;
          case 'jump': b.vel.y = 0.3; b.grounded = false; break;
          case 'stun': if(distToPlayer < 10) { P.stunned = 2; flash('STUMBLE', 500); showEmoji(player, 'üí´'); } bots.forEach(o => { if(o !== b && d3(b.mesh.position, o.mesh.position) < 10) { o.stunned = 2; showEmoji(o.mesh, 'üí´'); } }); break;
          case 'smoke': if(distToPlayer < 10) { P.stunned = 1.5; showEmoji(player, '‚ùì'); } bots.forEach(o => { if(o !== b && d3(b.mesh.position, o.mesh.position) < 10) { o.stunned = 1.5; showEmoji(o.mesh, '‚ùì'); } }); b.mesh.visible = false; setTimeout(() => b.mesh.visible = true, 2000); break;
          case 'buff': b.score += 20; showEmoji(b.mesh, 'üéÅ'); break;
        }
        showEmoji(b.mesh, b.ch.emoji);
      }
    }
    if(state === ST.LOBBY && d2(b.mesh.position, {x:0, z:0}) < 10) { if(b.grounded && Math.random() < 0.05) { b.vel.y = 0.25; b.grounded = false; } }

    if(b.mesh.position.y < -5) { b.mem.bad.push({x: b.mesh.position.x, z: b.mesh.position.z}); if(b.mem.bad.length > 10) b.mem.bad.shift(); b.mesh.position.set(0, 5, 0); b.vel.set(0,0,0); }
    b.aiTimer-=dt;
    if(b.aiTimer<=0){
      b.aiTimer=rnd(.3,1);
      if(curGame?.type==='collect'){
        let best=null,bestD=Infinity; stars.forEach(s=>{if(!s.userData.taken){const dd=d3(b.mesh.position,s.position);if(dd<bestD){bestD=dd;best=s;}}});
        if(best)b.target={x:best.position.x,z:best.position.z};
      }else if(curGame?.type==='hill'){ b.target={x:rnd(-5,5),z:rnd(-5,5)};
      }else if(curGame?.type==='tag'){
        if(b.isIt){
          let best=null,bestD=Infinity; if(!P.isIt&&P.tagImmune<=0){const dd=d2(b.mesh.position,player.position);if(dd<bestD){bestD=dd;best=player.position;}}
          bots.forEach(o=>{if(o!==b&&!o.isIt&&!o.eliminated&&o.tagImmune<=0){const dd=d2(b.mesh.position,o.mesh.position);if(dd<bestD){bestD=dd;best=o.mesh.position;}}});
          if(best)b.target={x:best.x,z:best.z};
        }else{
          const it=bots.find(o=>o.isIt)||(P.isIt?player:null); if(it){ const pos=it.position||it.mesh?.position; if(pos){const dx=b.mesh.position.x-pos.x,dz=b.mesh.position.z-pos.z,dd=Math.sqrt(dx*dx+dz*dz); if(dd>.1)b.target={x:b.mesh.position.x+(dx/dd)*22,z:b.mesh.position.z+(dz/dd)*22};} }
        }
      }else if(curGame?.type==='pads'&&!musicOn){ const active=pads.filter(p=>p.userData.active); if(active.length>0){const pad=active[idx%active.length];b.target={x:pad.position.x,z:pad.position.z};}
      }else if(curGame?.type==='sumo'){ if(Math.random()>.4){b.target={x:player.position.x,z:player.position.z};} else{const o=bots.filter(x=>x!==b&&!x.eliminated);if(o.length){const t=o[Math.floor(Math.random()*o.length)];b.target={x:t.mesh.position.x,z:t.mesh.position.z};}}
      }else b.target={x:rnd(-35,35),z:rnd(-35,35)};
    }
    if(b.target){
      let tx=b.target.x, tz=b.target.z;
      b.mem.bad.forEach(spot=>{ if(d2(b.mesh.position, spot) < 8){ const dx=b.mesh.position.x-spot.x, dz=b.mesh.position.z-spot.z, d=Math.sqrt(dx*dx+dz*dz)||1; tx += (dx/d)*15; tz += (dz/d)*15; } });
      const dx=tx-b.mesh.position.x,dz=tz-b.mesh.position.z,dd=Math.sqrt(dx*dx+dz*dz);
      if(dd>1.2){ const s=spd_base*(b.ch.spd/80); b.mesh.position.x+=(dx/dd)*s; b.mesh.position.z+=(dz/dd)*s; b.mesh.rotation.y=Math.atan2(dx,dz); }
    }
    applyBotPhysics(b);
    const bd=d2(b.mesh.position,{x:0,z:0}); const sumoR = (curGame?.type==='sumo'?28:70);
    if(bd>sumoR){ if(curGame?.type==='sumo'){b.score=Math.max(0,b.score-50);const a=rnd(0,Math.PI*2);b.mesh.position.set(Math.cos(a)*15,0,Math.sin(a)*15);} else{b.mesh.position.x*=sumoR/bd;b.mesh.position.z*=sumoR/bd;} }
    stars.forEach(s=>{ if(!s.userData.taken&&d3(b.mesh.position,s.position)<3){ s.userData.taken=true; scene.remove(s); b.score+=s.userData.val; if(state===ST.GAME && curGame?.type==='collect') setTimeout(()=>spawnStar(),4000); } });
    if(curGame?.type==='tag'&&b.isIt&&b.tagImmune<=0){
      if(!P.isIt&&P.tagImmune<=0&&d3(b.mesh.position,player.position)<3){ b.isIt=false; P.isIt=true; P.tagImmune=3; notify("‚ö†Ô∏è YOU'RE IT! -50",'bad'); P.score=Math.max(0,P.score-50); b.score+=100; updInd(); }
      bots.forEach(o=>{ if(o!==b&&!o.isIt&&!o.eliminated&&o.tagImmune<=0&&d3(b.mesh.position,o.mesh.position)<3){ b.isIt=false; o.isIt=true; o.tagImmune=3; b.score+=100; o.score=Math.max(0,o.score-50); updInd(); } });
    }
    if(curGame?.type==='hill'&&hillMesh){
      const hd=d2(b.mesh.position,{x:0,z:0});
      if(hd<hillMesh.radius&&b.mesh.position.y>=hillMesh.topY-.5){
        b.hillTime=(b.hillTime||0)+dt; if(b.hillTime>=1){b.score+=1;b.hillTime-=1;}
        if(b.hillTime>=5){ const a=rnd(0,Math.PI*2); b.vel.x+=Math.cos(a)*.5; b.vel.z+=Math.sin(a)*.5; b.vel.y=.25; b.hillTime=0; }
      }else b.hillTime=0;
    }
  });
}

function updateMinigame(dt){
  if(!gActive)return;
  if(P.tagImmune>0)P.tagImmune-=dt;
  if(!P.sprinting&&P.stamina<100)P.stamina=Math.min(100,P.stamina+22*dt);
  scoreT+=dt; if(P.buffTime>0)P.buffTime-=dt;
  const t=Date.now()*.001;
  gameMeshes.forEach(o=>{ if(o.userData.bob)o.position.y=(o.userData.baseY||4)+Math.sin(t*2)*.5; if(curGame?.type==='hill' && o.geometry.type==='ConeGeometry') o.scale.setScalar(1+Math.sin(t*5)*0.1); if(o.userData.spin)o.rotation.y+=dt; });
  stars.forEach(s=>{ if(!s.userData.taken){ s.position.y=2.5+Math.sin(t*3+s.userData.off)*.5; s.rotation.z+=dt*5; if(d3(player.position,s.position)<3){ s.userData.taken=true; scene.remove(s); P.score+=s.userData.val; mkParts(s.position.x,s.position.y,s.position.z,0xFFD700,18); if(state===ST.GAME && curGame?.type==='collect') setTimeout(()=>spawnStar(),4000); } } });
  if(curGame?.type==='hill'&&hillMesh){
    const hd=d2(player.position,{x:0,z:0});
    if(hd<hillMesh.radius&&player.position.y>=hillMesh.topY-.5){
      P.hillTime+=dt; if(P.hillTime>=1){P.score+=1;P.hillTime-=1;}
      if(P.hillTime>=5){ P.stunned=0; const a=rnd(0,Math.PI*2); pVel.x+=Math.cos(a)*.6; pVel.z+=Math.sin(a)*.6; pVel.y=.3; P.hillTime=0; notify('Knocked off!','inf'); mkParts(player.position.x,1.5,player.position.z,0xFFD700,20); }
    }else P.hillTime=0;
  }
  if(curGame?.type==='sumo'){
    const pd=d2(player.position,{x:0,z:0}); const sumoR = 40;
    if(gTimer < curGame.dur - 10) {
      const shrink = 1 - (curGame.dur - 10 - gTimer) / 100; const currentR = Math.max(15, 40 * shrink);
      if(gameMeshes[0]) gameMeshes[0].scale.set(currentR/40, 1, currentR/40); if(gameMeshes[1]) gameMeshes[1].scale.set(currentR/40, 1, currentR/40);
      if(pd > currentR) { P.score=Math.max(0,P.score-50); player.position.set(0,0,0); flash('STUMBLE',350); }
      bots.forEach(b => { if(!b.eliminated && d2(b.mesh.position,{x:0,z:0}) > currentR) { b.score=Math.max(0,b.score-50); b.mesh.position.set(0,0,0); } });
    }
  }
  if(curGame?.type==='tag'){
    const pd=d2(player.position,{x:0,z:0}); if(pd>70){player.position.x*=70/pd;player.position.z*=70/pd;}
    if(P.isIt&&P.tagImmune<=0){ bots.forEach(b=>{ if(!b.isIt&&!b.eliminated&&b.tagImmune<=0&&d3(player.position,b.mesh.position)<3){ P.isIt=false; b.isIt=true; b.tagImmune=3; P.tagImmune=2; notify('Tagged '+b.name+'! +100','ok'); P.score+=100; b.score=Math.max(0,b.score-50); updInd(); } }); }
  }
  if(curGame?.type==='pads' && musicOn){ const pd=d2(player.position,{x:0,z:0}); if(pd>70){player.position.x*=70/pd;player.position.z*=70/pd;} }
  if(curGame?.type==='collect'){ const pd=d2(player.position,{x:0,z:0}); if(pd>70){player.position.x*=70/pd;player.position.z*=70/pd;} }
  runBotAI(dt); updateSB(); updateMM();
}

function getAllScores(){
  return[{name:'You',score:Math.floor(P.score),emoji:curC().emoji,color:curC().color,isPlayer:true,isIt:P.isIt},
  ...bots.map(b=>({name:b.name,score:Math.floor(b.score),emoji:b.emoji,color:b.color,isPlayer:false,isIt:b.isIt,eliminated:b.eliminated}))
  ].sort((a,b)=>b.score-a.score);
}

function updateSB(){
  const body=$('sbBody'); if(!body)return;
  body.innerHTML='';
  getAllScores().slice(0,10).forEach((e,i)=>{
    const d=document.createElement('div'); d.className='sb-r'+(e.isPlayer?' me':'')+(i===0?' top':'');
    d.innerHTML=`<span class="sb-rk">${i+1}</span><span class="sb-nm">${e.emoji} ${e.name}${e.isIt?' üè∑Ô∏è':''}</span><span class="sb-sc">${e.score}</span>`;
    body.appendChild(d);
  });
}

function updateMM(){
  const mm=$('MM'); if(!mm)return;
  mm.classList.add('show'); mm.querySelectorAll('.mm-dot').forEach(d=>d.remove());
  bots.forEach(b=>{
    if(b.eliminated)return; const dx=b.mesh.position.x-player.position.x,dz=b.mesh.position.z-player.position.z;
    if(Math.abs(dx)<60&&Math.abs(dz)<60){ const dot=document.createElement('div'); dot.className='mm-dot bot'+(b.isIt?' it':''); dot.style.left=(50+dx*.65)+'px'; dot.style.top=(50+dz*.65)+'px'; mm.appendChild(dot); }
  });
}

function endMinigame(){ gActive=false; state=ST.RES; hide('GHUD'); hide('SB'); hide('IND'); $('BTNS').style.display='none'; showResults(); }

function addFriend(name, btn){ if(!P.friends.includes(name)) { P.friends.push(name); saveData(); } btn.textContent = 'FRIENDS ‚úÖ'; btn.classList.add('bg-white/10', 'text-gray-500'); btn.classList.remove('bg-primary', 'text-black'); btn.disabled=true; }

function showResults(){
  const scores=getAllScores(); const rank=scores.findIndex(s=>s.isPlayer)+1; const won=rank===1;
  setText('resT', won ? 'VICTORY!' : 'NICE WORK!'); setText('resS', `#${rank} ‚Äî ${Math.floor(P.score)} pts`);
  const pod=$('resPod'); if(pod){
    pod.innerHTML='';
    scores.slice(0,5).forEach((e,i)=>{
      const isFriend = P.friends.includes(e.name);
      const row = document.createElement('div'); row.className = `flex items-center justify-between p-4 rounded-2xl border ${e.isPlayer?'bg-primary/10 border-primary/40':'bg-card-dark border-white/5'}`;
      row.innerHTML = `<div class="flex items-center gap-3"><span class="font-black italic text-lg ${i==0?'text-primary':'text-gray-500'} w-4">${i+1}</span><div class="size-10 rounded-full bg-white/5 flex items-center justify-center g-emoji" style="background-image:url('${getGvEmoji(e.emoji)}')"></div><div class="flex flex-col"><span class="font-bold text-sm ${e.isPlayer?'text-primary':'text-white'}">${e.name}</span><span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${e.score} pts</span></div></div>${e.isPlayer ? '<span class="text-[10px] font-black text-primary uppercase">YOU</span>' : `<button class="px-3 py-1.5 rounded-full text-[10px] font-black transition-all ${isFriend?'bg-white/10 text-gray-500':'bg-primary text-black shadow-lg shadow-primary/20'}" onclick="addFriend('${e.name}', this)">${isFriend?'FRIENDS ‚úÖ':'ADD FRIEND'}</button>`}`;
      pod.appendChild(row);
    });
  }
  const shards=won?180:50+rank*15; P.gems+=shards; setText('hGems',P.gems);
  const rr=$('resRew'); if(rr) rr.innerHTML=`<div class="bg-primary/20 border border-primary/30 px-6 py-3 rounded-2xl flex items-center gap-3"><span class="text-2xl g-emoji size-8" style="background-image:url('${getGvEmoji('üíé')}')"></span><span class="text-primary font-black text-xl">+${shards}</span></div>`;
  show('RES');
  if(won)for(let i=0;i<50;i++)setTimeout(()=>{ const c=document.createElement('div');c.className='snow';c.textContent=(IS_DEC?['üéâ','üéä','‚≠ê','üéÑ','üéÖ']:['üéâ','üéä','‚≠ê','üíé','üèÜ'])[Math.floor(Math.random()*5)];c.style.left=rnd(0,100)+'vw';c.style.fontSize='24px';c.style.animationDuration=rnd(3,5)+'s';$('PARTS')?.appendChild(c);setTimeout(()=>c.remove(),5000); },i*40);
  const next=$('resNext'); if(next) { next.textContent = rGames.length>0&&rIdx<rGames.length-1?'NEXT RIFT':'PLAY AGAIN'; next.onclick=()=>{hide('RES');if(rGames.length>0&&rIdx<rGames.length-1){rIdx++;setTimeout(()=>startMinigame(rGames[rIdx]),400);}else backToLobby();}; }
}

function backToLobby(){
  state=ST.LOBBY; curGame=null; rGames=[]; rIdx=0; hillMesh=null; hide('RES'); $('hud').style.display='flex'; hide('IND'); $('SIDE').style.display='none'; $('bGrab')?.classList.remove('hidden');
  scene.background=new THREE.Color(0x1a2a4a); scene.fog=new THREE.FogExp2(0x1a2a4a,.005);
  buildLobby(); player.visible=true; player.position.set(0,3.5,22); pVel={x:0,y:0,z:0};
  bots.forEach((b,i)=>{b.mesh.visible=true;b.eliminated=false;const a=((i+1)/(bots.length+1))*Math.PI*2;b.mesh.position.set(Math.cos(a)*24,0,Math.sin(a)*24);});
}

function mkParts(x,y,z,col,n){
  for(let i=0;i<n;i++){
    const m=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.9}); const p=sMesh(new THREE.SphereGeometry(.15,8,6),m); p.position.set(x,y,z); p.userData={vx:rnd(-.5,.5),vy:rnd(.2,.55),vz:rnd(-.5,.5),life:1,m}; scene.add(p); particles3d.push(p);
  }
}

function showEmoji(parent, text){
  const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
  const ctx = canvas.getContext('2d'); ctx.font = '80px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(text, 64, 64);
  const tex = new THREE.CanvasTexture(canvas); const smat = new THREE.SpriteMaterial({map: tex, transparent: true});
  const sprite = new THREE.Sprite(smat); sprite.position.y = 3.2; sprite.scale.set(2, 2, 2); parent.add(sprite);
  let start = Date.now(); const ani = () => { let age = (Date.now() - start) / 2000; if(age >= 1) { parent.remove(sprite); return; } sprite.position.y = 3.2 + age * 1.5; sprite.material.opacity = 1 - age; requestAnimationFrame(ani); }; ani();
}

function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(clk.getDelta(),.05);
  if(P.settings.debug){ const fpsEl=$("fps"); if(fpsEl) { fpsEl.style.display="block"; fpsEl.textContent="FPS: "+Math.round(1/dt); } }
  if(P.grabCD>0)P.grabCD-=dt; if(P.skillCD>0)P.skillCD-=dt;
  const t=Date.now()*.001;
  if(state===ST.LOBBY){
    const c=curC(); const inp=joy.l; const sprint=P.sprinting?1.4:1; const spd=SPD*(c.spd/80)*sprint*0.75; const mag=Math.sqrt(inp.x**2+inp.y**2);
    if(mag>.1){ const ang=Math.atan2(inp.x,inp.y)+camAng; pVel.x+=Math.sin(ang)*mag*spd*.12; pVel.z+=Math.cos(ang)*mag*spd*.12; player.rotation.y=ang; }
    applyPhysics(player.position,pVel); const pd=d2(player.position,{x:0,z:0}); if(pd>100){player.position.x*=100/pd;player.position.z*=100/pd;}
    if(Math.abs(joy.r.x)>.1)camAng-=joy.r.x*.035;
    let closest=null,closestD=Infinity; interacts.forEach(o=>{const dd=d3(player.position,o.position);if(dd<(o.userData.r||10)&&dd<closestD){closestD=dd;closest=o;}});
    near=closest; const prompt=$('PROMPT');
    if(near && !document.querySelector('.overlay.show')){ $('prIcon').style.backgroundImage = `url('${getGvEmoji(near.userData.icon)}')`; setText('prText',near.userData.text); prompt?.classList.add('show'); }else prompt?.classList.remove('show');
    updateMM();
    lobbyMeshes.forEach(o=>{if(o.userData?.spin)o.rotation.y+=dt;if(o.userData?.bob)o.position.y=(o.userData.baseY||4)+Math.sin(t*2)*.4;});
    bots.forEach((b,i)=>{ if(Math.random()<.01||!b.target)b.target={x:rnd(-40,40),z:rnd(-40,40)}; const dx=b.target.x-b.mesh.position.x,dz=b.target.z-b.mesh.position.z,dd=Math.sqrt(dx*dx+dz*dz); if(dd>1.5){b.mesh.position.x+=(dx/dd)*.05;b.mesh.position.z+=(dz/dd)*.05;b.mesh.rotation.y=Math.atan2(dx,dz);} applyBotPhysics(b); });
  }else if(state===ST.GAME){
    if(gActive&&P.stunned<=0){
      const c=curC(); const inp=joy.l; const sprint=(P.sprinting&&P.stamina>0?1.4:1)*(P.buffTime>0?1.3:1); if(P.sprinting&&P.stamina>0)P.stamina=Math.max(0,P.stamina-dt*30);
      const spd=SPD*(c.spd/80)*sprint*.42*(curGame?.type==='pads'?!musicOn?0.15:0.7:1); const mag=Math.sqrt(inp.x**2+inp.y**2);
      if(mag>.1){ const ang=Math.atan2(inp.x,inp.y)+camAng; pVel.x+=Math.sin(ang)*mag*spd; pVel.z+=Math.cos(ang)*mag*spd; player.rotation.y=ang; }
      if(Math.abs(joy.r.x)>.1)camAng-=joy.r.x*.035; if(P.sprinting&&mag>.3)flash('SPEED',80);
    }else if(P.stunned>0)P.stunned-=dt;
    applyPhysics(player.position,pVel); updateMinigame(dt);
  }
  for(let i=particles3d.length-1;i>=0;i--){ const p=particles3d[i]; p.position.x+=p.userData.vx;p.position.y+=p.userData.vy;p.position.z+=p.userData.vz; p.userData.vy-=.025;p.userData.life-=dt*4; if(p.userData.m)p.userData.m.opacity=p.userData.life; if(p.userData.life<=0){scene.remove(p);particles3d.splice(i,1);} }
  const tX=player.position.x+Math.sin(camAng)*22, tZ=player.position.z+Math.cos(camAng)*22, tY=player.position.y+16;
  cam.position.x+=(tX-cam.position.x)*.12; cam.position.y+=(tY-cam.position.y)*.12; cam.position.z+=(tZ-cam.position.z)*.12;
  if(shakeAmt>0){cam.position.x+=rnd(-shakeAmt,shakeAmt);cam.position.y+=rnd(-shakeAmt,shakeAmt);shakeAmt*=.8;if(shakeAmt<.01)shakeAmt=0;}
  cam.lookAt(player.position.x,player.position.y+2.5,player.position.z);
  if(sun){sun.position.set(player.position.x+80,120,player.position.z+80);sun.target.position.copy(player.position);sun.target.updateMatrixWorld();}
  ren.render(scene,cam);
}

function updSet(){
  const s = P.settings; const oldShadows = s.shadows; const oldPreset = P.preset; const oldAcc = s.acc;
  s.shadows = $('sShadow').checked; s.ai = $('sAI').value; s.leftHand = $('sLeft').checked; s.acc = $('sAcc').checked; s.debug = $('sDebug').checked; P.preset = $('sGraph')?.value || P.preset;
  saveData();
  if(s.acc !== oldAcc) { document.documentElement.style.fontSize = s.acc ? "18px" : "16px"; }
  const joyL = $('joyL'), joyR = $('joyR'), btns = $('BTNS');
  if(s.leftHand) {
      if(joyL) { joyL.style.left='auto'; joyL.style.right='18px'; } if(joyR) { joyR.style.right='auto'; joyR.style.left='18px'; } if(btns) { btns.style.right='auto'; btns.style.left='14px'; }
  } else {
      if(joyL) { joyL.style.right='auto'; joyL.style.left='18px'; } if(joyR) { joyR.style.left='auto'; joyR.style.right='18px'; } if(btns) { btns.style.left='auto'; btns.style.right='14px'; }
  }
  if(s.shadows !== oldShadows || P.preset !== oldPreset) { if(confirm("Graphics settings require a reload. Reload now?")) location.reload(); }
}

function setPreset(p){ P.preset = p; P.settings.shadows = (p !== 'classic'); const sg = $('sGraph'); if(sg) sg.value = p; const ss = $('sShadow'); if(ss) ss.checked = P.settings.shadows; saveData(); location.reload(); }

function startLoad(){
  let p=0; const iv=setInterval(()=>{ p+=rnd(16,28);if(p>100)p=100; const fill=$('ldFill');if(fill)fill.style.width=p+'%'; if(p>=100){clearInterval(iv);setTimeout(()=>{$('LD')?.classList.add('gone');state=ST.LOBBY;},500);} },130);
}

function updInd(){ const ind=$('IND'); if(!ind)return; if(curGame?.type==='pads'){ ind.textContent=musicOn?'üéµ DANCE!':'‚õî STOP! ON GREEN!'; ind.style.color=musicOn?'#fff':'#f00'; ind.style.display='block'; }else if(curGame?.type==='tag'){ ind.textContent=P.isIt?'‚ö†Ô∏è YOU ARE IT! TAG SOMEONE!':'‚úÖ SAFE'; ind.style.color=P.isIt?'#f00':'#fff'; ind.style.display='block'; }else ind.style.display='none'; }

function resetPads(){ pads.forEach(p=>{ p.material.color.setHex(0x9C27B0); p.userData.active=true; }); }

function checkPads(){
  const winners=new Set();
  pads.forEach(pad=>{
    let count=0;
    const pd=d2(player.position,pad.position); if(pd<6&&player.position.y>=.5){ winners.add('player'); count++; }
    bots.forEach(b=>{ const bd=d2(b.mesh.position,pad.position); if(bd<6&&b.mesh.position.y>=.5){ winners.add(b.name); count++; } });
    if(count>0) pad.material.color.setHex(0x44FF44); else { pad.userData.active=false; pad.material.color.setHex(0x333333); }
  });
  if(winners.has('player')){ P.score+=25; notify('Safe! +25','ok'); } else { P.score=Math.max(0,P.score-40); flash('STUMBLE',350); notify('No pad! -40','bad'); }
  bots.forEach(b => { if(b.eliminated) return; if(winners.has(b.name)) b.score+=25; else b.score=Math.max(0,b.score-40); });
  setTimeout(()=>{musicOn=true;resetPads();updInd();},2000);
}

loadData(); initThree(); buildLobby(); spawnPlayer(); spawnBots(5); initControls(); startLoad();
window.DEBUG = { gotoLobby: () => backToLobby(), start: (id) => { let g; if(typeof id === "number") g = GAMES[id]; else g = GAMES.find(x => x.id === id); if(g) startMinigame(g); else console.error("Game not found:", id); }, show: (id) => show(id), setGems: (n) => { P.gems = n; setText('hGems', n); }, setLv: (n) => { P.lv = n; setText('hLv', n); } };
animate();

</script>
</body>
</html>